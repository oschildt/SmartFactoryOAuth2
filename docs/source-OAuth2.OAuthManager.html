<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="stylesheet" href="resources/bootstrap.min.css">
        <link rel="stylesheet" href="resources/style.css">
        <link rel="stylesheet" href="resources/jquery.iviewer.css">

        <title>
            Source Code: OAuth2\OAuthManager.php - SmartFactory OAuth2 Server
        </title>
    </head>

    <body>
        <div id="navigation">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <nav class="navbar">
                    <ul class="nav navbar-nav">
                        
                        
                        <li>
                            <a href="index.html" class="">
                                Overview
                            </a>
                        </li>
                        
                        <li>
                            <a href="classes.html" class="">
                                Classes
                            </a>
                        </li>
                        
                        <li>
                            <a href="interfaces.html" class="">
                                Interfaces
                            </a>
                        </li>
                        
                        <li>
                            <a href="diagram.html" class="">
                                Diagram
                            </a>
                        </li>
                        
                        <li>
                            <a href="structure.html" class="">
                                Structure
                            </a>
                        </li>
                        

                    </ul>

                    <form id="search" class="pull-right">
                        <input type="text" name="q" class="form-control text" placeholder="Search class, function or namespace">
                    </form>
                </nav>
            </div>
        </div>
    </div>
</div>

        
        
        
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h2>Source Code: OAuth2\OAuthManager.php</h2>

<div id="source"><pre class="code"><code><span class="line" id="1">   1: </span><span class="xlang">&lt;?php</span>
<span class="line" id="2">   2: </span><span class="php-comment">/**
</span><span class="line" id="3">   3: </span><span class="php-comment"> * This file contains the implementation of the interface IOAuthManager for secure user authentication.
</span><span class="line" id="4">   4: </span><span class="php-comment"> *
</span><span class="line" id="5">   5: </span><span class="php-comment"> * @author Oleg Schildt
</span><span class="line" id="6">   6: </span><span class="php-comment"> */</span>
<span class="line" id="7">   7: </span>
<span class="line" id="8">   8: </span><span class="php-keyword1">namespace</span> OAuth2;
<span class="line" id="9">   9: </span>
<span class="line" id="10">  10: </span><span class="php-keyword1">use</span> OAuth2\Interfaces\IOAuthManager;
<span class="line" id="11">  11: </span><span class="php-keyword1">use</span> OAuth2\Interfaces\ITokenStorage;
<span class="line" id="12">  12: </span><span class="php-keyword1">use</span> OAuth2\Interfaces\IUserAuthenticator;
<span class="line" id="13">  13: </span>
<span class="line" id="14">  14: </span>
<span class="line" id="15">  15: </span><span class="php-comment">/**
</span><span class="line" id="16">  16: </span><span class="php-comment"> * Class for secure user authentication.
</span><span class="line" id="17">  17: </span><span class="php-comment"> *
</span><span class="line" id="18">  18: </span><span class="php-comment"> * @author Oleg Schildt
</span><span class="line" id="19">  19: </span><span class="php-comment"> */</span>
<span class="line" id="20">  20: </span><span class="php-keyword1">class</span> OAuthManager <span class="php-keyword1">implements</span> IOAuthManager
<span class="line" id="21">  21: </span>{
<span class="line" id="22">  22: </span>    <span class="php-comment">/**
</span><span class="line" id="23">  23: </span><span class="php-comment">     * Internal reference to the token storage object.
</span><span class="line" id="24">  24: </span><span class="php-comment">     *
</span><span class="line" id="25">  25: </span><span class="php-comment">     * It must implement {@see \OAuth2\Interfaces\ITokenStorage}.
</span><span class="line" id="26">  26: </span><span class="php-comment">     *
</span><span class="line" id="27">  27: </span><span class="php-comment">     * @var \OAuth2\Interfaces\ITokenStorage
</span><span class="line" id="28">  28: </span><span class="php-comment">     *
</span><span class="line" id="29">  29: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="30">  30: </span><span class="php-comment">     */</span>
<span class="line" id="31">  31: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$token_storage</span> = <span class="php-keyword1">null</span>;
<span class="line" id="32">  32: </span>    
<span class="line" id="33">  33: </span>    <span class="php-comment">/**
</span><span class="line" id="34">  34: </span><span class="php-comment">     * Internal reference to the user authenticator object.
</span><span class="line" id="35">  35: </span><span class="php-comment">     *
</span><span class="line" id="36">  36: </span><span class="php-comment">     * It must implement {@see \OAuth2\Interfaces\IUserAuthenticator}.
</span><span class="line" id="37">  37: </span><span class="php-comment">     *
</span><span class="line" id="38">  38: </span><span class="php-comment">     * @var \OAuth2\Interfaces\IUserAuthenticator
</span><span class="line" id="39">  39: </span><span class="php-comment">     *
</span><span class="line" id="40">  40: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="41">  41: </span><span class="php-comment">     */</span>
<span class="line" id="42">  42: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$user_authenticator</span> = <span class="php-keyword1">null</span>;
<span class="line" id="43">  43: </span>    
<span class="line" id="44">  44: </span>    <span class="php-comment">/**
</span><span class="line" id="45">  45: </span><span class="php-comment">     * Internal property for storing the sekret key.
</span><span class="line" id="46">  46: </span><span class="php-comment">     *
</span><span class="line" id="47">  47: </span><span class="php-comment">     * The secret key is required for the algoritms HS256, HS384, HS512.
</span><span class="line" id="48">  48: </span><span class="php-comment">     *
</span><span class="line" id="49">  49: </span><span class="php-comment">     * @var string
</span><span class="line" id="50">  50: </span><span class="php-comment">     *
</span><span class="line" id="51">  51: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="52">  52: </span><span class="php-comment">     */</span>
<span class="line" id="53">  53: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$secret_key</span> = <span class="php-keyword1">null</span>;
<span class="line" id="54">  54: </span>    
<span class="line" id="55">  55: </span>    <span class="php-comment">/**
</span><span class="line" id="56">  56: </span><span class="php-comment">     * Internal property for storing the encryption algorithm.
</span><span class="line" id="57">  57: </span><span class="php-comment">     *
</span><span class="line" id="58">  58: </span><span class="php-comment">     * The supported algorithms are HS256, HS384, HS512, RS256, RS384, RS512.
</span><span class="line" id="59">  59: </span><span class="php-comment">     *
</span><span class="line" id="60">  60: </span><span class="php-comment">     * @var string
</span><span class="line" id="61">  61: </span><span class="php-comment">     *
</span><span class="line" id="62">  62: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="63">  63: </span><span class="php-comment">     */</span>
<span class="line" id="64">  64: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$encryption_algorithm</span> = <span class="php-keyword1">null</span>;
<span class="line" id="65">  65: </span>    
<span class="line" id="66">  66: </span>    <span class="php-comment">/**
</span><span class="line" id="67">  67: </span><span class="php-comment">     * Internal property for storing the time to live of the access token.
</span><span class="line" id="68">  68: </span><span class="php-comment">     *
</span><span class="line" id="69">  69: </span><span class="php-comment">     * @var string
</span><span class="line" id="70">  70: </span><span class="php-comment">     *
</span><span class="line" id="71">  71: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="72">  72: </span><span class="php-comment">     */</span>
<span class="line" id="73">  73: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$access_token_ttl</span> = <span class="php-keyword1">null</span>;
<span class="line" id="74">  74: </span>    
<span class="line" id="75">  75: </span>    <span class="php-comment">/**
</span><span class="line" id="76">  76: </span><span class="php-comment">     * Internal property for storing the time to live of the refresh token.
</span><span class="line" id="77">  77: </span><span class="php-comment">     *
</span><span class="line" id="78">  78: </span><span class="php-comment">     * @var string
</span><span class="line" id="79">  79: </span><span class="php-comment">     *
</span><span class="line" id="80">  80: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="81">  81: </span><span class="php-comment">     */</span>
<span class="line" id="82">  82: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$refresh_token_ttl</span> = <span class="php-keyword1">null</span>;
<span class="line" id="83">  83: </span>    
<span class="line" id="84">  84: </span>    <span class="php-comment">/**
</span><span class="line" id="85">  85: </span><span class="php-comment">     * Internal property for storing the number of maximal inactivity days of the token.
</span><span class="line" id="86">  86: </span><span class="php-comment">     *
</span><span class="line" id="87">  87: </span><span class="php-comment">     * @var string
</span><span class="line" id="88">  88: </span><span class="php-comment">     *
</span><span class="line" id="89">  89: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="90">  90: </span><span class="php-comment">     */</span>
<span class="line" id="91">  91: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$max_token_inactivity_days</span> = <span class="php-keyword1">null</span>;
<span class="line" id="92">  92: </span>    
<span class="line" id="93">  93: </span>    <span class="php-comment">/**
</span><span class="line" id="94">  94: </span><span class="php-comment">     * Internal property for storing the path to the public key file.
</span><span class="line" id="95">  95: </span><span class="php-comment">     *
</span><span class="line" id="96">  96: </span><span class="php-comment">     * Required for the algorithms: RS256, RS384, RS512.
</span><span class="line" id="97">  97: </span><span class="php-comment">     *
</span><span class="line" id="98">  98: </span><span class="php-comment">     * @var string
</span><span class="line" id="99">  99: </span><span class="php-comment">     *
</span><span class="line" id="100"> 100: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="101"> 101: </span><span class="php-comment">     */</span>
<span class="line" id="102"> 102: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$public_key</span> = <span class="php-keyword1">null</span>;
<span class="line" id="103"> 103: </span>    
<span class="line" id="104"> 104: </span>    <span class="php-comment">/**
</span><span class="line" id="105"> 105: </span><span class="php-comment">     * Internal property for storing the path to the provate key file.
</span><span class="line" id="106"> 106: </span><span class="php-comment">     *
</span><span class="line" id="107"> 107: </span><span class="php-comment">     * Required for the algorithms: RS256, RS384, RS512.
</span><span class="line" id="108"> 108: </span><span class="php-comment">     *
</span><span class="line" id="109"> 109: </span><span class="php-comment">     * @var string
</span><span class="line" id="110"> 110: </span><span class="php-comment">     *
</span><span class="line" id="111"> 111: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="112"> 112: </span><span class="php-comment">     */</span>
<span class="line" id="113"> 113: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$private_key</span> = <span class="php-keyword1">null</span>;
<span class="line" id="114"> 114: </span>    
<span class="line" id="115"> 115: </span>    <span class="php-comment">/**
</span><span class="line" id="116"> 116: </span><span class="php-comment">     * Internal property for storing the pass phrase for the private key.
</span><span class="line" id="117"> 117: </span><span class="php-comment">     *
</span><span class="line" id="118"> 118: </span><span class="php-comment">     * Only required, if the private key was generated with a pass phrase.
</span><span class="line" id="119"> 119: </span><span class="php-comment">     *
</span><span class="line" id="120"> 120: </span><span class="php-comment">     * @var string
</span><span class="line" id="121"> 121: </span><span class="php-comment">     *
</span><span class="line" id="122"> 122: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="123"> 123: </span><span class="php-comment">     */</span>
<span class="line" id="124"> 124: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$pass_phrase</span> = <span class="php-quote">&quot;&quot;</span>;
<span class="line" id="125"> 125: </span>    
<span class="line" id="126"> 126: </span>    <span class="php-comment">/**
</span><span class="line" id="127"> 127: </span><span class="php-comment">     * Internal property for the list of supported algorithms.
</span><span class="line" id="128"> 128: </span><span class="php-comment">     *
</span><span class="line" id="129"> 129: </span><span class="php-comment">     * @var array
</span><span class="line" id="130"> 130: </span><span class="php-comment">     *
</span><span class="line" id="131"> 131: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="132"> 132: </span><span class="php-comment">     */</span>
<span class="line" id="133"> 133: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$supported_algorithms</span> = [<span class="php-quote">'HS256'</span>, <span class="php-quote">'HS384'</span>, <span class="php-quote">'HS512'</span>, <span class="php-quote">'RS256'</span>, <span class="php-quote">'RS384'</span>, <span class="php-quote">'RS512'</span>];
<span class="line" id="134"> 134: </span>    
<span class="line" id="135"> 135: </span>    <span class="php-comment">/**
</span><span class="line" id="136"> 136: </span><span class="php-comment">     * Internal auxiliary function for safe base64 encoding.
</span><span class="line" id="137"> 137: </span><span class="php-comment">     *
</span><span class="line" id="138"> 138: </span><span class="php-comment">     * @param string $data
</span><span class="line" id="139"> 139: </span><span class="php-comment">     * Data to be encoded.
</span><span class="line" id="140"> 140: </span><span class="php-comment">     *
</span><span class="line" id="141"> 141: </span><span class="php-comment">     * @return string
</span><span class="line" id="142"> 142: </span><span class="php-comment">     * Returns the base64 encoded data string.
</span><span class="line" id="143"> 143: </span><span class="php-comment">     *
</span><span class="line" id="144"> 144: </span><span class="php-comment">     * @see urlSafeB64Decode()
</span><span class="line" id="145"> 145: </span><span class="php-comment">     *
</span><span class="line" id="146"> 146: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="147"> 147: </span><span class="php-comment">     */</span>
<span class="line" id="148"> 148: </span>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> urlSafeB64Encode(<span class="php-var">$data</span>)
<span class="line" id="149"> 149: </span>    {
<span class="line" id="150"> 150: </span>        <span class="php-var">$b64</span> = <span class="php-keyword2">base64_encode</span>(<span class="php-var">$data</span>);
<span class="line" id="151"> 151: </span>        <span class="php-var">$b64</span> = <span class="php-keyword2">str_replace</span>(<span class="php-keyword1">array</span>(<span class="php-quote">'+'</span>, <span class="php-quote">'/'</span>, <span class="php-quote">&quot;\r&quot;</span>, <span class="php-quote">&quot;\n&quot;</span>, <span class="php-quote">'='</span>), <span class="php-keyword1">array</span>(<span class="php-quote">'-'</span>, <span class="php-quote">'_'</span>), <span class="php-var">$b64</span>);
<span class="line" id="152"> 152: </span>        
<span class="line" id="153"> 153: </span>        <span class="php-keyword1">return</span> <span class="php-var">$b64</span>;
<span class="line" id="154"> 154: </span>    }
<span class="line" id="155"> 155: </span>    
<span class="line" id="156"> 156: </span>    <span class="php-comment">/**
</span><span class="line" id="157"> 157: </span><span class="php-comment">     * Internal auxiliary function for safe base64 decoding.
</span><span class="line" id="158"> 158: </span><span class="php-comment">     *
</span><span class="line" id="159"> 159: </span><span class="php-comment">     * @param string $b64
</span><span class="line" id="160"> 160: </span><span class="php-comment">     * Data to be decoded.
</span><span class="line" id="161"> 161: </span><span class="php-comment">     *
</span><span class="line" id="162"> 162: </span><span class="php-comment">     * @return string
</span><span class="line" id="163"> 163: </span><span class="php-comment">     * Returns the base64 decoded data string.
</span><span class="line" id="164"> 164: </span><span class="php-comment">     *
</span><span class="line" id="165"> 165: </span><span class="php-comment">     * @see urlSafeB64Encode()
</span><span class="line" id="166"> 166: </span><span class="php-comment">     *
</span><span class="line" id="167"> 167: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="168"> 168: </span><span class="php-comment">     */</span>
<span class="line" id="169"> 169: </span>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> urlSafeB64Decode(<span class="php-var">$b64</span>)
<span class="line" id="170"> 170: </span>    {
<span class="line" id="171"> 171: </span>        <span class="php-var">$b64</span> = <span class="php-keyword2">str_replace</span>(<span class="php-keyword1">array</span>(<span class="php-quote">'-'</span>, <span class="php-quote">'_'</span>), <span class="php-keyword1">array</span>(<span class="php-quote">'+'</span>, <span class="php-quote">'/'</span>), <span class="php-var">$b64</span>);
<span class="line" id="172"> 172: </span>        
<span class="line" id="173"> 173: </span>        <span class="php-keyword1">return</span> <span class="php-keyword2">base64_decode</span>(<span class="php-var">$b64</span>);
<span class="line" id="174"> 174: </span>    }
<span class="line" id="175"> 175: </span>    
<span class="line" id="176"> 176: </span>    <span class="php-comment">/**
</span><span class="line" id="177"> 177: </span><span class="php-comment">     * Internal auxiliary function for verification of the data signature for the algorithms
</span><span class="line" id="178"> 178: </span><span class="php-comment">     * RS256, RS384, RS512.
</span><span class="line" id="179"> 179: </span><span class="php-comment">     *
</span><span class="line" id="180"> 180: </span><span class="php-comment">     * @param string $input
</span><span class="line" id="181"> 181: </span><span class="php-comment">     * Data which is signed.
</span><span class="line" id="182"> 182: </span><span class="php-comment">     *
</span><span class="line" id="183"> 183: </span><span class="php-comment">     * @param string $signature
</span><span class="line" id="184"> 184: </span><span class="php-comment">     * Signature used for signing the data.
</span><span class="line" id="185"> 185: </span><span class="php-comment">     *
</span><span class="line" id="186"> 186: </span><span class="php-comment">     * @param string $algorithm_id
</span><span class="line" id="187"> 187: </span><span class="php-comment">     * Algorithm used for signing. The supported algorithms are: RS256, RS384, RS512.
</span><span class="line" id="188"> 188: </span><span class="php-comment">     *
</span><span class="line" id="189"> 189: </span><span class="php-comment">     * @return boolean
</span><span class="line" id="190"> 190: </span><span class="php-comment">     * Returns true if the verification was successful, otherwise false.
</span><span class="line" id="191"> 191: </span><span class="php-comment">     *
</span><span class="line" id="192"> 192: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="193"> 193: </span><span class="php-comment">     * It might throw an exception in the case of any system errors:
</span><span class="line" id="194"> 194: </span><span class="php-comment">     *
</span><span class="line" id="195"> 195: </span><span class="php-comment">     * - if any required initialization parameters are empty.
</span><span class="line" id="196"> 196: </span><span class="php-comment">     * - if any initialization parameters are invalid.
</span><span class="line" id="197"> 197: </span><span class="php-comment">     * - if token_storage does not implement {@see \OAuth2\Interfaces\ITokenStorage}.
</span><span class="line" id="198"> 198: </span><span class="php-comment">     * - if user_authenticator does not implement {@see \OAuth2\Interfaces\IUserAuthenticator}.
</span><span class="line" id="199"> 199: </span><span class="php-comment">     * - if the public key is invalid.
</span><span class="line" id="200"> 200: </span><span class="php-comment">     * - if the ssl verification cannot be performed due to system errors.
</span><span class="line" id="201"> 201: </span><span class="php-comment">     *
</span><span class="line" id="202"> 202: </span><span class="php-comment">     * @uses generateRSASignature()
</span><span class="line" id="203"> 203: </span><span class="php-comment">     *
</span><span class="line" id="204"> 204: </span><span class="php-comment">     * @used_by verifyJwtSignature()
</span><span class="line" id="205"> 205: </span><span class="php-comment">     *
</span><span class="line" id="206"> 206: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="207"> 207: </span><span class="php-comment">     */</span>
<span class="line" id="208"> 208: </span>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> verifyRSASignature(<span class="php-var">$input</span>, <span class="php-var">$signature</span>, <span class="php-var">$algorithm_id</span>)
<span class="line" id="209"> 209: </span>    {
<span class="line" id="210"> 210: </span>        <span class="php-var">$this</span>-&gt;validateParameters();
<span class="line" id="211"> 211: </span>        
<span class="line" id="212"> 212: </span>        <span class="php-var">$public_key</span> = <span class="php-keyword2">openssl_pkey_get_public</span>(<span class="php-quote">&quot;file://&quot;</span> . <span class="php-var">$this</span>-&gt;public_key);
<span class="line" id="213"> 213: </span>        <span class="php-keyword1">if</span> (<span class="php-var">$public_key</span> === <span class="php-keyword1">false</span>) {
<span class="line" id="214"> 214: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">&quot;The public key file '%s' is not valid! Error: %s&quot;</span>, <span class="php-var">$this</span>-&gt;public_key, <span class="php-keyword2">openssl_error_string</span>()));
<span class="line" id="215"> 215: </span>        }
<span class="line" id="216"> 216: </span>        
<span class="line" id="217"> 217: </span>        <span class="php-var">$result</span> = @<span class="php-keyword2">openssl_verify</span>(<span class="php-var">$input</span>, <span class="php-var">$signature</span>, <span class="php-var">$public_key</span>, <span class="php-var">$algorithm_id</span>);
<span class="line" id="218"> 218: </span>        
<span class="line" id="219"> 219: </span>        <span class="php-keyword1">if</span> (<span class="php-var">$result</span> == -<span class="php-num">1</span>) {
<span class="line" id="220"> 220: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">&quot;Error by data verification: %s&quot;</span>, <span class="php-keyword2">openssl_error_string</span>()));
<span class="line" id="221"> 221: </span>        }
<span class="line" id="222"> 222: </span>        
<span class="line" id="223"> 223: </span>        <span class="php-keyword1">return</span> <span class="php-var">$result</span> === <span class="php-num">1</span>;
<span class="line" id="224"> 224: </span>    }
<span class="line" id="225"> 225: </span>    
<span class="line" id="226"> 226: </span>    <span class="php-comment">/**
</span><span class="line" id="227"> 227: </span><span class="php-comment">     * Internal auxiliary function for generation of the signature of the data for the algorithms
</span><span class="line" id="228"> 228: </span><span class="php-comment">     * RS256, RS384, RS512.
</span><span class="line" id="229"> 229: </span><span class="php-comment">     *
</span><span class="line" id="230"> 230: </span><span class="php-comment">     * @param string $input
</span><span class="line" id="231"> 231: </span><span class="php-comment">     * Data which is signed.
</span><span class="line" id="232"> 232: </span><span class="php-comment">     *
</span><span class="line" id="233"> 233: </span><span class="php-comment">     * @param string $algorithm_id
</span><span class="line" id="234"> 234: </span><span class="php-comment">     * Algorithm to use for signing. The supported algorithms are: RS256, RS384, RS512.
</span><span class="line" id="235"> 235: </span><span class="php-comment">     *
</span><span class="line" id="236"> 236: </span><span class="php-comment">     * @return string
</span><span class="line" id="237"> 237: </span><span class="php-comment">     * Returns the signature of the data.
</span><span class="line" id="238"> 238: </span><span class="php-comment">     *
</span><span class="line" id="239"> 239: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="240"> 240: </span><span class="php-comment">     * It might throw an exception in the case of any system errors:
</span><span class="line" id="241"> 241: </span><span class="php-comment">     *
</span><span class="line" id="242"> 242: </span><span class="php-comment">     * - if any required initialization parameters are empty.
</span><span class="line" id="243"> 243: </span><span class="php-comment">     * - if any initialization parameters are invalid.
</span><span class="line" id="244"> 244: </span><span class="php-comment">     * - if token_storage does not implement {@see \OAuth2\Interfaces\ITokenStorage}.
</span><span class="line" id="245"> 245: </span><span class="php-comment">     * - if user_authenticator does not implement {@see \OAuth2\Interfaces\IUserAuthenticator}.
</span><span class="line" id="246"> 246: </span><span class="php-comment">     * - if the private key is invalid.
</span><span class="line" id="247"> 247: </span><span class="php-comment">     * - if ssl signing fails due to system errors.
</span><span class="line" id="248"> 248: </span><span class="php-comment">     *
</span><span class="line" id="249"> 249: </span><span class="php-comment">     * @see verifyRSASignature()
</span><span class="line" id="250"> 250: </span><span class="php-comment">     *
</span><span class="line" id="251"> 251: </span><span class="php-comment">     * @used_by generateJwtSignature()
</span><span class="line" id="252"> 252: </span><span class="php-comment">     *
</span><span class="line" id="253"> 253: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="254"> 254: </span><span class="php-comment">     */</span>
<span class="line" id="255"> 255: </span>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> generateRSASignature(<span class="php-var">$input</span>, <span class="php-var">$algorithm_id</span>)
<span class="line" id="256"> 256: </span>    {
<span class="line" id="257"> 257: </span>        <span class="php-var">$this</span>-&gt;validateParameters();
<span class="line" id="258"> 258: </span>        
<span class="line" id="259"> 259: </span>        <span class="php-var">$private_key</span> = <span class="php-keyword2">openssl_pkey_get_private</span>(<span class="php-quote">&quot;file://&quot;</span> . <span class="php-var">$this</span>-&gt;private_key, <span class="php-var">$this</span>-&gt;pass_phrase);
<span class="line" id="260"> 260: </span>        <span class="php-keyword1">if</span> (<span class="php-var">$private_key</span> === <span class="php-keyword1">false</span>) {
<span class="line" id="261"> 261: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">&quot;The private key file '%s' or the pass phrase is not valid! Error: %s&quot;</span>, <span class="php-var">$this</span>-&gt;private_key, <span class="php-keyword2">openssl_error_string</span>()));
<span class="line" id="262"> 262: </span>        }
<span class="line" id="263"> 263: </span>        
<span class="line" id="264"> 264: </span>        <span class="php-var">$signature</span> = <span class="php-quote">&quot;&quot;</span>;
<span class="line" id="265"> 265: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">openssl_sign</span>(<span class="php-var">$input</span>, <span class="php-var">$signature</span>, <span class="php-var">$private_key</span>, <span class="php-var">$algorithm_id</span>)) {
<span class="line" id="266"> 266: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">&quot;Error by signing data: %s&quot;</span>, <span class="php-keyword2">openssl_error_string</span>()));
<span class="line" id="267"> 267: </span>        }
<span class="line" id="268"> 268: </span>        
<span class="line" id="269"> 269: </span>        <span class="php-keyword1">return</span> <span class="php-var">$signature</span>;
<span class="line" id="270"> 270: </span>    }
<span class="line" id="271"> 271: </span>    
<span class="line" id="272"> 272: </span>    <span class="php-comment">/**
</span><span class="line" id="273"> 273: </span><span class="php-comment">     * Internal auxiliary function for generation of the signature of the data for all supported algorithms.
</span><span class="line" id="274"> 274: </span><span class="php-comment">     *
</span><span class="line" id="275"> 275: </span><span class="php-comment">     * @param string $input
</span><span class="line" id="276"> 276: </span><span class="php-comment">     * Data to be signed.
</span><span class="line" id="277"> 277: </span><span class="php-comment">     *
</span><span class="line" id="278"> 278: </span><span class="php-comment">     * @return string
</span><span class="line" id="279"> 279: </span><span class="php-comment">     * Returns the signature of the data.
</span><span class="line" id="280"> 280: </span><span class="php-comment">     *
</span><span class="line" id="281"> 281: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="282"> 282: </span><span class="php-comment">     * It might throw an exception in the case of any system errors:
</span><span class="line" id="283"> 283: </span><span class="php-comment">     *
</span><span class="line" id="284"> 284: </span><span class="php-comment">     * - if any required initialization parameters are empty.
</span><span class="line" id="285"> 285: </span><span class="php-comment">     * - if any initialization parameters are invalid.
</span><span class="line" id="286"> 286: </span><span class="php-comment">     * - if token_storage does not implement {@see \OAuth2\Interfaces\ITokenStorage}.
</span><span class="line" id="287"> 287: </span><span class="php-comment">     * - if user_authenticator does not implement {@see \OAuth2\Interfaces\IUserAuthenticator}.
</span><span class="line" id="288"> 288: </span><span class="php-comment">     * - if the private key is invalid.
</span><span class="line" id="289"> 289: </span><span class="php-comment">     * - if ssl signing fails due to system errors.
</span><span class="line" id="290"> 290: </span><span class="php-comment">     *
</span><span class="line" id="291"> 291: </span><span class="php-comment">     * @uses generateRSASignature()
</span><span class="line" id="292"> 292: </span><span class="php-comment">     *
</span><span class="line" id="293"> 293: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="294"> 294: </span><span class="php-comment">     */</span>
<span class="line" id="295"> 295: </span>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> generateJwtSignature(<span class="php-var">$input</span>)
<span class="line" id="296"> 296: </span>    {
<span class="line" id="297"> 297: </span>        <span class="php-keyword1">switch</span> (<span class="php-var">$this</span>-&gt;encryption_algorithm) {
<span class="line" id="298"> 298: </span>            <span class="php-keyword1">case</span> <span class="php-quote">'HS256'</span>:
<span class="line" id="299"> 299: </span>                <span class="php-keyword1">return</span> <span class="php-keyword2">hash_hmac</span>(<span class="php-quote">'sha256'</span>, <span class="php-var">$input</span>, <span class="php-var">$this</span>-&gt;secret_key, <span class="php-keyword1">true</span>);
<span class="line" id="300"> 300: </span>            
<span class="line" id="301"> 301: </span>            <span class="php-keyword1">case</span> <span class="php-quote">'HS384'</span>:
<span class="line" id="302"> 302: </span>                <span class="php-keyword1">return</span> <span class="php-keyword2">hash_hmac</span>(<span class="php-quote">'sha384'</span>, <span class="php-var">$input</span>, <span class="php-var">$this</span>-&gt;secret_key, <span class="php-keyword1">true</span>);
<span class="line" id="303"> 303: </span>            
<span class="line" id="304"> 304: </span>            <span class="php-keyword1">case</span> <span class="php-quote">'HS512'</span>:
<span class="line" id="305"> 305: </span>                <span class="php-keyword1">return</span> <span class="php-keyword2">hash_hmac</span>(<span class="php-quote">'sha512'</span>, <span class="php-var">$input</span>, <span class="php-var">$this</span>-&gt;secret_key, <span class="php-keyword1">true</span>);
<span class="line" id="306"> 306: </span>            
<span class="line" id="307"> 307: </span>            <span class="php-keyword1">case</span> <span class="php-quote">'RS256'</span>:
<span class="line" id="308"> 308: </span>                <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;generateRSASignature(<span class="php-var">$input</span>, OPENSSL_ALGO_SHA256);
<span class="line" id="309"> 309: </span>            
<span class="line" id="310"> 310: </span>            <span class="php-keyword1">case</span> <span class="php-quote">'RS384'</span>:
<span class="line" id="311"> 311: </span>                <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;generateRSASignature(<span class="php-var">$input</span>, OPENSSL_ALGO_SHA384);
<span class="line" id="312"> 312: </span>            
<span class="line" id="313"> 313: </span>            <span class="php-keyword1">case</span> <span class="php-quote">'RS512'</span>:
<span class="line" id="314"> 314: </span>                <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;generateRSASignature(<span class="php-var">$input</span>, OPENSSL_ALGO_SHA512);
<span class="line" id="315"> 315: </span>            
<span class="line" id="316"> 316: </span>            <span class="php-keyword1">default</span>:
<span class="line" id="317"> 317: </span>                <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">&quot;Unsupported or invalid signing algorithm '%s'.&quot;</span>, <span class="php-var">$this</span>-&gt;encryption_algorithm));
<span class="line" id="318"> 318: </span>        }
<span class="line" id="319"> 319: </span>    }
<span class="line" id="320"> 320: </span>    
<span class="line" id="321"> 321: </span>    <span class="php-comment">/**
</span><span class="line" id="322"> 322: </span><span class="php-comment">     * Internal auxiliary function for verification of the signature of the data for all supported algorithms.
</span><span class="line" id="323"> 323: </span><span class="php-comment">     *
</span><span class="line" id="324"> 324: </span><span class="php-comment">     * @param string $input
</span><span class="line" id="325"> 325: </span><span class="php-comment">     * Data which was signed.
</span><span class="line" id="326"> 326: </span><span class="php-comment">     *
</span><span class="line" id="327"> 327: </span><span class="php-comment">     * @param string $signature
</span><span class="line" id="328"> 328: </span><span class="php-comment">     * Signature used for signing.
</span><span class="line" id="329"> 329: </span><span class="php-comment">     *
</span><span class="line" id="330"> 330: </span><span class="php-comment">     * @return boolean
</span><span class="line" id="331"> 331: </span><span class="php-comment">     * Returns true if the verification was successful, otherwise false.
</span><span class="line" id="332"> 332: </span><span class="php-comment">     *
</span><span class="line" id="333"> 333: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="334"> 334: </span><span class="php-comment">     * It might throw an exception in the case of any errors:
</span><span class="line" id="335"> 335: </span><span class="php-comment">     *
</span><span class="line" id="336"> 336: </span><span class="php-comment">     * - if any required initialization parameters are empty.
</span><span class="line" id="337"> 337: </span><span class="php-comment">     * - if any initialization parameters are invalid.
</span><span class="line" id="338"> 338: </span><span class="php-comment">     * - if token_storage does not implement {@see \OAuth2\Interfaces\ITokenStorage}.
</span><span class="line" id="339"> 339: </span><span class="php-comment">     * - if user_authenticator does not implement {@see \OAuth2\Interfaces\IUserAuthenticator}.
</span><span class="line" id="340"> 340: </span><span class="php-comment">     * - if the public key is invalid.
</span><span class="line" id="341"> 341: </span><span class="php-comment">     * - if the ssl verification cannot be performed due to system errors.
</span><span class="line" id="342"> 342: </span><span class="php-comment">     *
</span><span class="line" id="343"> 343: </span><span class="php-comment">     * @uses verifyRSASignature()
</span><span class="line" id="344"> 344: </span><span class="php-comment">     *
</span><span class="line" id="345"> 345: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="346"> 346: </span><span class="php-comment">     */</span>
<span class="line" id="347"> 347: </span>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> verifyJwtSignature(<span class="php-var">$input</span>, <span class="php-var">$signature</span>)
<span class="line" id="348"> 348: </span>    {
<span class="line" id="349"> 349: </span>        <span class="php-keyword1">switch</span> (<span class="php-var">$this</span>-&gt;encryption_algorithm) {
<span class="line" id="350"> 350: </span>            <span class="php-keyword1">case</span><span class="php-quote">'HS256'</span>:
<span class="line" id="351"> 351: </span>            <span class="php-keyword1">case</span><span class="php-quote">'HS384'</span>:
<span class="line" id="352"> 352: </span>            <span class="php-keyword1">case</span><span class="php-quote">'HS512'</span>:
<span class="line" id="353"> 353: </span>                <span class="php-keyword1">return</span> hash_equals(<span class="php-var">$this</span>-&gt;generateJwtSignature(<span class="php-var">$input</span>), <span class="php-var">$signature</span>);
<span class="line" id="354"> 354: </span>            
<span class="line" id="355"> 355: </span>            <span class="php-keyword1">case</span> <span class="php-quote">'RS256'</span>:
<span class="line" id="356"> 356: </span>                <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;verifyRSASignature(<span class="php-var">$input</span>, <span class="php-var">$signature</span>, OPENSSL_ALGO_SHA256);
<span class="line" id="357"> 357: </span>            
<span class="line" id="358"> 358: </span>            <span class="php-keyword1">case</span> <span class="php-quote">'RS384'</span>:
<span class="line" id="359"> 359: </span>                <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;verifyRSASignature(<span class="php-var">$input</span>, <span class="php-var">$signature</span>, OPENSSL_ALGO_SHA384);
<span class="line" id="360"> 360: </span>            
<span class="line" id="361"> 361: </span>            <span class="php-keyword1">case</span> <span class="php-quote">'RS512'</span>:
<span class="line" id="362"> 362: </span>                <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;verifyRSASignature(<span class="php-var">$input</span>, <span class="php-var">$signature</span>, OPENSSL_ALGO_SHA512);
<span class="line" id="363"> 363: </span>            
<span class="line" id="364"> 364: </span>            <span class="php-keyword1">default</span>:
<span class="line" id="365"> 365: </span>                <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">&quot;Unsupported or invalid signing algorithm '%s'.&quot;</span>, <span class="php-var">$this</span>-&gt;encryption_algorithm), <span class="php-quote">&quot;system_error&quot;</span>);
<span class="line" id="366"> 366: </span>        }
<span class="line" id="367"> 367: </span>        
<span class="line" id="368"> 368: </span>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<span class="line" id="369"> 369: </span>    }
<span class="line" id="370"> 370: </span>    
<span class="line" id="371"> 371: </span>    <span class="php-comment">/**
</span><span class="line" id="372"> 372: </span><span class="php-comment">     * Internal auxiliary function for generation of a token string.
</span><span class="line" id="373"> 373: </span><span class="php-comment">     *
</span><span class="line" id="374"> 374: </span><span class="php-comment">     * @return string
</span><span class="line" id="375"> 375: </span><span class="php-comment">     * Returns the token string.
</span><span class="line" id="376"> 376: </span><span class="php-comment">     *
</span><span class="line" id="377"> 377: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="378"> 378: </span><span class="php-comment">     * It might throw an exception in the case of any system errors:
</span><span class="line" id="379"> 379: </span><span class="php-comment">     *
</span><span class="line" id="380"> 380: </span><span class="php-comment">     * - if ssl funtions fail due to system errors.
</span><span class="line" id="381"> 381: </span><span class="php-comment">     *
</span><span class="line" id="382"> 382: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="383"> 383: </span><span class="php-comment">     */</span>
<span class="line" id="384"> 384: </span>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> generateToken()
<span class="line" id="385"> 385: </span>    {
<span class="line" id="386"> 386: </span>        <span class="php-keyword1">try</span> {
<span class="line" id="387"> 387: </span>            <span class="php-keyword1">if</span> (<span class="php-keyword2">function_exists</span>(<span class="php-quote">'random_bytes'</span>)) {
<span class="line" id="388"> 388: </span>                <span class="php-var">$randomData</span> = random_bytes(<span class="php-num">20</span>);
<span class="line" id="389"> 389: </span>                <span class="php-keyword1">if</span> (<span class="php-var">$randomData</span> !== <span class="php-keyword1">false</span> &amp;&amp; <span class="php-keyword2">strlen</span>(<span class="php-var">$randomData</span>) === <span class="php-num">20</span>) {
<span class="line" id="390"> 390: </span>                    <span class="php-keyword1">return</span> <span class="php-keyword2">bin2hex</span>(<span class="php-var">$randomData</span>);
<span class="line" id="391"> 391: </span>                }
<span class="line" id="392"> 392: </span>            }
<span class="line" id="393"> 393: </span>            
<span class="line" id="394"> 394: </span>            <span class="php-keyword1">if</span> (<span class="php-keyword2">function_exists</span>(<span class="php-quote">'openssl_random_pseudo_bytes'</span>)) {
<span class="line" id="395"> 395: </span>                <span class="php-var">$randomData</span> = <span class="php-keyword2">openssl_random_pseudo_bytes</span>(<span class="php-num">20</span>);
<span class="line" id="396"> 396: </span>                <span class="php-keyword1">if</span> (<span class="php-var">$randomData</span> !== <span class="php-keyword1">false</span> &amp;&amp; <span class="php-keyword2">strlen</span>(<span class="php-var">$randomData</span>) === <span class="php-num">20</span>) {
<span class="line" id="397"> 397: </span>                    <span class="php-keyword1">return</span> <span class="php-keyword2">bin2hex</span>(<span class="php-var">$randomData</span>);
<span class="line" id="398"> 398: </span>                }
<span class="line" id="399"> 399: </span>            }
<span class="line" id="400"> 400: </span>        } <span class="php-keyword1">catch</span> (\Exception <span class="php-var">$ex</span>) {
<span class="line" id="401"> 401: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-var">$ex</span>-&gt;getMessage());
<span class="line" id="402"> 402: </span>        }
<span class="line" id="403"> 403: </span>        
<span class="line" id="404"> 404: </span>        <span class="php-comment">// last resort which you probably should just get rid of:</span>
<span class="line" id="405"> 405: </span>        <span class="php-var">$randomData</span> = <span class="php-keyword2">mt_rand</span>() . <span class="php-keyword2">mt_rand</span>() . <span class="php-keyword2">mt_rand</span>() . <span class="php-keyword2">mt_rand</span>() . <span class="php-keyword2">microtime</span>(<span class="php-keyword1">true</span>) . <span class="php-keyword2">uniqid</span>(<span class="php-keyword2">mt_rand</span>(), <span class="php-keyword1">true</span>);
<span class="line" id="406"> 406: </span>        
<span class="line" id="407"> 407: </span>        <span class="php-keyword1">return</span> <span class="php-keyword2">substr</span>(<span class="php-keyword2">hash</span>(<span class="php-quote">'sha512'</span>, <span class="php-var">$randomData</span>), <span class="php-num">0</span>, <span class="php-num">40</span>);
<span class="line" id="408"> 408: </span>    } <span class="php-comment">// generateToken</span>
<span class="line" id="409"> 409: </span>    
<span class="line" id="410"> 410: </span>    <span class="php-comment">/**
</span><span class="line" id="411"> 411: </span><span class="php-comment">     * Internal auxiliary function for creation of the jwt token.
</span><span class="line" id="412"> 412: </span><span class="php-comment">     *
</span><span class="line" id="413"> 413: </span><span class="php-comment">     * @param array $payload
</span><span class="line" id="414"> 414: </span><span class="php-comment">     * The payload array.
</span><span class="line" id="415"> 415: </span><span class="php-comment">     *
</span><span class="line" id="416"> 416: </span><span class="php-comment">     * @return string
</span><span class="line" id="417"> 417: </span><span class="php-comment">     * Returns the jwt token string.
</span><span class="line" id="418"> 418: </span><span class="php-comment">     *
</span><span class="line" id="419"> 419: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="420"> 420: </span><span class="php-comment">     * It might throw an exception in the case of any system errors:
</span><span class="line" id="421"> 421: </span><span class="php-comment">     *
</span><span class="line" id="422"> 422: </span><span class="php-comment">     * - if any required initialization parameters are empty.
</span><span class="line" id="423"> 423: </span><span class="php-comment">     * - if any initialization parameters are invalid.
</span><span class="line" id="424"> 424: </span><span class="php-comment">     * - if token_storage does not implement {@see \OAuth2\Interfaces\ITokenStorage}.
</span><span class="line" id="425"> 425: </span><span class="php-comment">     * - if user_authenticator does not implement {@see \OAuth2\Interfaces\IUserAuthenticator}.
</span><span class="line" id="426"> 426: </span><span class="php-comment">     * - if the private key is invalid.
</span><span class="line" id="427"> 427: </span><span class="php-comment">     * - if ssl signing fails due to system errors.
</span><span class="line" id="428"> 428: </span><span class="php-comment">     *
</span><span class="line" id="429"> 429: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="430"> 430: </span><span class="php-comment">     */</span>
<span class="line" id="431"> 431: </span>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> createJwtToken(<span class="php-var">$payload</span>)
<span class="line" id="432"> 432: </span>    {
<span class="line" id="433"> 433: </span>        <span class="php-var">$header</span> = [<span class="php-quote">&quot;typ&quot;</span> =&gt; <span class="php-quote">&quot;JWT&quot;</span>, <span class="php-quote">&quot;alg&quot;</span> =&gt; <span class="php-var">$this</span>-&gt;encryption_algorithm];
<span class="line" id="434"> 434: </span>        
<span class="line" id="435"> 435: </span>        <span class="php-var">$segments</span> = [<span class="php-var">$this</span>-&gt;urlSafeB64Encode(<span class="php-keyword2">json_encode</span>(<span class="php-var">$header</span>)), <span class="php-var">$this</span>-&gt;urlSafeB64Encode(<span class="php-keyword2">json_encode</span>(<span class="php-var">$payload</span>))];
<span class="line" id="436"> 436: </span>        
<span class="line" id="437"> 437: </span>        <span class="php-var">$signature</span> = <span class="php-var">$this</span>-&gt;generateJwtSignature(<span class="php-keyword2">implode</span>(<span class="php-quote">'.'</span>, <span class="php-var">$segments</span>));
<span class="line" id="438"> 438: </span>        
<span class="line" id="439"> 439: </span>        <span class="php-var">$segments</span>[] = <span class="php-var">$this</span>-&gt;urlsafeB64Encode(<span class="php-var">$signature</span>);
<span class="line" id="440"> 440: </span>        
<span class="line" id="441"> 441: </span>        <span class="php-keyword1">return</span> <span class="php-keyword2">implode</span>(<span class="php-quote">'.'</span>, <span class="php-var">$segments</span>);
<span class="line" id="442"> 442: </span>    }
<span class="line" id="443"> 443: </span>    
<span class="line" id="444"> 444: </span>    <span class="php-comment">/**
</span><span class="line" id="445"> 445: </span><span class="php-comment">     * Internal auxiliary function for extraction of the payload from the jwt access token.
</span><span class="line" id="446"> 446: </span><span class="php-comment">     *
</span><span class="line" id="447"> 447: </span><span class="php-comment">     * @param string $jwt_access_token
</span><span class="line" id="448"> 448: </span><span class="php-comment">     * The jwt access token.
</span><span class="line" id="449"> 449: </span><span class="php-comment">     *
</span><span class="line" id="450"> 450: </span><span class="php-comment">     * @param boolean $verify_signature
</span><span class="line" id="451"> 451: </span><span class="php-comment">     * The flag to control whether the signature should be verified or not.
</span><span class="line" id="452"> 452: </span><span class="php-comment">     *
</span><span class="line" id="453"> 453: </span><span class="php-comment">     * @return array
</span><span class="line" id="454"> 454: </span><span class="php-comment">     * Returns the extracted payload array.
</span><span class="line" id="455"> 455: </span><span class="php-comment">     *
</span><span class="line" id="456"> 456: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="457"> 457: </span><span class="php-comment">     * It might throw an exception in the case of any errors:
</span><span class="line" id="458"> 458: </span><span class="php-comment">     *
</span><span class="line" id="459"> 459: </span><span class="php-comment">     * - if any required initialization parameters are empty.
</span><span class="line" id="460"> 460: </span><span class="php-comment">     * - if any initialization parameters are invalid.
</span><span class="line" id="461"> 461: </span><span class="php-comment">     * - if token_storage does not implement {@see \OAuth2\Interfaces\ITokenStorage}.
</span><span class="line" id="462"> 462: </span><span class="php-comment">     * - if user_authenticator does not implement {@see \OAuth2\Interfaces\IUserAuthenticator}.
</span><span class="line" id="463"> 463: </span><span class="php-comment">     * - if the public key is invalid.
</span><span class="line" id="464"> 464: </span><span class="php-comment">     * - if the ssl verification cannot be performed due to system errors.
</span><span class="line" id="465"> 465: </span><span class="php-comment">     *
</span><span class="line" id="466"> 466: </span><span class="php-comment">     * @throws \OAuth2\InvalidTokenException
</span><span class="line" id="467"> 467: </span><span class="php-comment">     * It might throw the InvalidTokenException if the jwt access token is invalid.
</span><span class="line" id="468"> 468: </span><span class="php-comment">     *
</span><span class="line" id="469"> 469: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="470"> 470: </span><span class="php-comment">     */</span>
<span class="line" id="471"> 471: </span>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> getJwtPayload(<span class="php-var">$jwt_access_token</span>, <span class="php-var">$verify_signature</span> = <span class="php-keyword1">true</span>)
<span class="line" id="472"> 472: </span>    {
<span class="line" id="473"> 473: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">strpos</span>(<span class="php-var">$jwt_access_token</span>, <span class="php-quote">'.'</span>)) {
<span class="line" id="474"> 474: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidTokenException(<span class="php-quote">&quot;The format of the JWT access token is invalid!&quot;</span>);
<span class="line" id="475"> 475: </span>        }
<span class="line" id="476"> 476: </span>        
<span class="line" id="477"> 477: </span>        <span class="php-var">$segements</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">'.'</span>, <span class="php-var">$jwt_access_token</span>);
<span class="line" id="478"> 478: </span>        
<span class="line" id="479"> 479: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$segements</span>) != <span class="php-num">3</span>) {
<span class="line" id="480"> 480: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidTokenException(<span class="php-quote">&quot;The format of the JWT access token is invalid!&quot;</span>);
<span class="line" id="481"> 481: </span>        }
<span class="line" id="482"> 482: </span>        
<span class="line" id="483"> 483: </span>        <span class="php-keyword1">list</span>(<span class="php-var">$headb64</span>, <span class="php-var">$payloadb64</span>, <span class="php-var">$cryptob64</span>) = <span class="php-var">$segements</span>;
<span class="line" id="484"> 484: </span>        
<span class="line" id="485"> 485: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">null</span> === (<span class="php-var">$header</span> = <span class="php-keyword2">json_decode</span>(<span class="php-var">$this</span>-&gt;urlSafeB64Decode(<span class="php-var">$headb64</span>), <span class="php-keyword1">true</span>))) {
<span class="line" id="486"> 486: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidTokenException(<span class="php-quote">&quot;The header of the JWT access token is invalid!&quot;</span>);
<span class="line" id="487"> 487: </span>        }
<span class="line" id="488"> 488: </span>        
<span class="line" id="489"> 489: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">null</span> === <span class="php-var">$payload</span> = <span class="php-keyword2">json_decode</span>(<span class="php-var">$this</span>-&gt;urlSafeB64Decode(<span class="php-var">$payloadb64</span>), <span class="php-keyword1">true</span>)) {
<span class="line" id="490"> 490: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidTokenException(<span class="php-quote">&quot;The payload of the JWT access token is invalid!&quot;</span>);
<span class="line" id="491"> 491: </span>        }
<span class="line" id="492"> 492: </span>        
<span class="line" id="493"> 493: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$verify_signature</span>) {
<span class="line" id="494"> 494: </span>            <span class="php-keyword1">return</span> <span class="php-var">$payload</span>;
<span class="line" id="495"> 495: </span>        }
<span class="line" id="496"> 496: </span>        
<span class="line" id="497"> 497: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$header</span>[<span class="php-quote">'alg'</span>])) {
<span class="line" id="498"> 498: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidTokenException(<span class="php-quote">&quot;The signing algorithm of the JWT access token is missing in the header!&quot;</span>);
<span class="line" id="499"> 499: </span>        }
<span class="line" id="500"> 500: </span>        
<span class="line" id="501"> 501: </span>        <span class="php-var">$signature</span> = <span class="php-var">$this</span>-&gt;urlSafeB64Decode(<span class="php-var">$cryptob64</span>);
<span class="line" id="502"> 502: </span>        
<span class="line" id="503"> 503: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-var">$header</span>[<span class="php-quote">'alg'</span>], <span class="php-var">$this</span>-&gt;supported_algorithms)) {
<span class="line" id="504"> 504: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidTokenException(<span class="php-quote">&quot;The signing algorithm of the JWT access token is invalid!&quot;</span>);
<span class="line" id="505"> 505: </span>        }
<span class="line" id="506"> 506: </span>        
<span class="line" id="507"> 507: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;verifyJwtSignature(<span class="php-quote">&quot;</span><span class="php-var">$headb64</span><span class="php-quote">.</span><span class="php-var">$payloadb64</span><span class="php-quote">&quot;</span>, <span class="php-var">$signature</span>)) {
<span class="line" id="508"> 508: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidTokenException(<span class="php-quote">&quot;The signature of the JWT access token is invalid!&quot;</span>);
<span class="line" id="509"> 509: </span>        }
<span class="line" id="510"> 510: </span>        
<span class="line" id="511"> 511: </span>        <span class="php-keyword1">return</span> <span class="php-var">$payload</span>;
<span class="line" id="512"> 512: </span>    }
<span class="line" id="513"> 513: </span>    
<span class="line" id="514"> 514: </span>    <span class="php-comment">/**
</span><span class="line" id="515"> 515: </span><span class="php-comment">     * Internal auxiliary function for validation of the parameters.
</span><span class="line" id="516"> 516: </span><span class="php-comment">     *
</span><span class="line" id="517"> 517: </span><span class="php-comment">     * @return boolean
</span><span class="line" id="518"> 518: </span><span class="php-comment">     * returns true upon successful validation, otherwise false.
</span><span class="line" id="519"> 519: </span><span class="php-comment">     *
</span><span class="line" id="520"> 520: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="521"> 521: </span><span class="php-comment">     * It might throw an exception in the case of any system errors:
</span><span class="line" id="522"> 522: </span><span class="php-comment">     *
</span><span class="line" id="523"> 523: </span><span class="php-comment">     * - if any required initialization parameters are empty.
</span><span class="line" id="524"> 524: </span><span class="php-comment">     * - if any initialization parameters are invalid.
</span><span class="line" id="525"> 525: </span><span class="php-comment">     * - if token_storage does not implement {@see \OAuth2\Interfaces\ITokenStorage}.
</span><span class="line" id="526"> 526: </span><span class="php-comment">     * - if user_authenticator does not implement {@see \OAuth2\Interfaces\IUserAuthenticator}.
</span><span class="line" id="527"> 527: </span><span class="php-comment">     *
</span><span class="line" id="528"> 528: </span><span class="php-comment">     * @used_by verifyRSASignature()
</span><span class="line" id="529"> 529: </span><span class="php-comment">     * @used_by generateRSASignature()
</span><span class="line" id="530"> 530: </span><span class="php-comment">     * @used_by init()
</span><span class="line" id="531"> 531: </span><span class="php-comment">     *
</span><span class="line" id="532"> 532: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="533"> 533: </span><span class="php-comment">     */</span>
<span class="line" id="534"> 534: </span>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> validateParameters()
<span class="line" id="535"> 535: </span>    {
<span class="line" id="536"> 536: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;access_token_ttl) || !<span class="php-keyword2">is_numeric</span>(<span class="php-var">$this</span>-&gt;access_token_ttl) || <span class="php-var">$this</span>-&gt;access_token_ttl &lt; <span class="php-num">1</span>) {
<span class="line" id="537"> 537: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-quote">&quot;The 'access_token_ttl' is not specified or invalid!&quot;</span>);
<span class="line" id="538"> 538: </span>        }
<span class="line" id="539"> 539: </span>        
<span class="line" id="540"> 540: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;refresh_token_ttl) || !<span class="php-keyword2">is_numeric</span>(<span class="php-var">$this</span>-&gt;refresh_token_ttl) || <span class="php-var">$this</span>-&gt;refresh_token_ttl &lt; <span class="php-num">1</span>) {
<span class="line" id="541"> 541: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-quote">&quot;The 'refresh_token_ttl' is not specified or invalid!&quot;</span>);
<span class="line" id="542"> 542: </span>        }
<span class="line" id="543"> 543: </span>        
<span class="line" id="544"> 544: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;max_token_inactivity_days) || !<span class="php-keyword2">is_numeric</span>(<span class="php-var">$this</span>-&gt;max_token_inactivity_days) || <span class="php-var">$this</span>-&gt;max_token_inactivity_days &lt; <span class="php-num">1</span>) {
<span class="line" id="545"> 545: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-quote">&quot;The 'max_token_inactivity_days' is not specified or invalid!&quot;</span>);
<span class="line" id="546"> 546: </span>        }
<span class="line" id="547"> 547: </span>        
<span class="line" id="548"> 548: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;token_storage)) {
<span class="line" id="549"> 549: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-quote">&quot;The 'token_storage' is not specified!&quot;</span>);
<span class="line" id="550"> 550: </span>        }
<span class="line" id="551"> 551: </span>        
<span class="line" id="552"> 552: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;token_storage <span class="php-keyword1">instanceof</span> ITokenStorage) {
<span class="line" id="553"> 553: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">&quot;The 'token_storage' does not implement the interface '%s'!&quot;</span>, ITokenStorage::<span class="php-keyword1">class</span>));
<span class="line" id="554"> 554: </span>        }
<span class="line" id="555"> 555: </span>        
<span class="line" id="556"> 556: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;user_authenticator)) {
<span class="line" id="557"> 557: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-quote">&quot;The 'user_authenticator' is not specified!&quot;</span>);
<span class="line" id="558"> 558: </span>        }
<span class="line" id="559"> 559: </span>        
<span class="line" id="560"> 560: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;user_authenticator <span class="php-keyword1">instanceof</span> IUserAuthenticator) {
<span class="line" id="561"> 561: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">&quot;The 'user_authenticator' does not implement the interface '%s'!&quot;</span>, IUserAuthenticator::<span class="php-keyword1">class</span>));
<span class="line" id="562"> 562: </span>        }
<span class="line" id="563"> 563: </span>        
<span class="line" id="564"> 564: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;encryption_algorithm)) {
<span class="line" id="565"> 565: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-quote">&quot;The encryption algorithm is not specified!&quot;</span>);
<span class="line" id="566"> 566: </span>        }
<span class="line" id="567"> 567: </span>        
<span class="line" id="568"> 568: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-var">$this</span>-&gt;encryption_algorithm, <span class="php-var">$this</span>-&gt;supported_algorithms)) {
<span class="line" id="569"> 569: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">&quot;The encryption algorithm %s is not supported! The suppoted algoritms are: %s&quot;</span>, <span class="php-var">$this</span>-&gt;encryption_algorithm, <span class="php-keyword2">implode</span>(<span class="php-quote">&quot;, &quot;</span>, <span class="php-var">$this</span>-&gt;supported_algorithms)));
<span class="line" id="570"> 570: </span>        }
<span class="line" id="571"> 571: </span>        
<span class="line" id="572"> 572: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$this</span>-&gt;encryption_algorithm, [<span class="php-quote">'HS256'</span>, <span class="php-quote">'HS384'</span>, <span class="php-quote">'HS512'</span>]) &amp;&amp; <span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;secret_key)) {
<span class="line" id="573"> 573: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">&quot;The encryption algorithm %s requires a secret key! Set the parameter 'secret_key'.&quot;</span>, <span class="php-var">$this</span>-&gt;encryption_algorithm));
<span class="line" id="574"> 574: </span>        }
<span class="line" id="575"> 575: </span>        
<span class="line" id="576"> 576: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$this</span>-&gt;encryption_algorithm, [<span class="php-quote">'RS256'</span>, <span class="php-quote">'RS384'</span>, <span class="php-quote">'RS512'</span>]) &amp;&amp; (<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;public_key) || <span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;private_key))) {
<span class="line" id="577"> 577: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">&quot;The encryption algorithm %s requires a public key and a private key! Set the parameters 'public_key' and 'private_key'.&quot;</span>, <span class="php-var">$this</span>-&gt;encryption_algorithm));
<span class="line" id="578"> 578: </span>        }
<span class="line" id="579"> 579: </span>        
<span class="line" id="580"> 580: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">file_exists</span>(<span class="php-var">$this</span>-&gt;private_key)) {
<span class="line" id="581"> 581: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">&quot;The private key file '%s' does not exists!&quot;</span>, <span class="php-var">$this</span>-&gt;private_key));
<span class="line" id="582"> 582: </span>        }
<span class="line" id="583"> 583: </span>        
<span class="line" id="584"> 584: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">file_exists</span>(<span class="php-var">$this</span>-&gt;public_key)) {
<span class="line" id="585"> 585: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \Exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">&quot;The public key file '%s' does not exists!&quot;</span>, <span class="php-var">$this</span>-&gt;public_key));
<span class="line" id="586"> 586: </span>        }
<span class="line" id="587"> 587: </span>        
<span class="line" id="588"> 588: </span>        <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<span class="line" id="589"> 589: </span>    }
<span class="line" id="590"> 590: </span>    
<span class="line" id="591"> 591: </span>    <span class="php-comment">/**
</span><span class="line" id="592"> 592: </span><span class="php-comment">     * Internal auxiliary function for creation of the token record.
</span><span class="line" id="593"> 593: </span><span class="php-comment">     *
</span><span class="line" id="594"> 594: </span><span class="php-comment">     * @param string $user_id
</span><span class="line" id="595"> 595: </span><span class="php-comment">     * The user id for which the tokens were issued.
</span><span class="line" id="596"> 596: </span><span class="php-comment">     *
</span><span class="line" id="597"> 597: </span><span class="php-comment">     * @param string $client_id
</span><span class="line" id="598"> 598: </span><span class="php-comment">     * The client id for which the tokens were issued.
</span><span class="line" id="599"> 599: </span><span class="php-comment">     *
</span><span class="line" id="600"> 600: </span><span class="php-comment">     * @param array $response
</span><span class="line" id="601"> 601: </span><span class="php-comment">     * The response to be filled with the user data and tokens.
</span><span class="line" id="602"> 602: </span><span class="php-comment">     *
</span><span class="line" id="603"> 603: </span><span class="php-comment">     * @return boolean
</span><span class="line" id="604"> 604: </span><span class="php-comment">     * returns true upon successful creation, otherwise false.
</span><span class="line" id="605"> 605: </span><span class="php-comment">     *
</span><span class="line" id="606"> 606: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="607"> 607: </span><span class="php-comment">     * It might throw an exception in the case of any errors:
</span><span class="line" id="608"> 608: </span><span class="php-comment">     *
</span><span class="line" id="609"> 609: </span><span class="php-comment">     * - if any required initialization parameters are empty.
</span><span class="line" id="610"> 610: </span><span class="php-comment">     * - if any initialization parameters are invalid.
</span><span class="line" id="611"> 611: </span><span class="php-comment">     * - if token_storage does not implement {@see \OAuth2\Interfaces\ITokenStorage}.
</span><span class="line" id="612"> 612: </span><span class="php-comment">     * - if user_authenticator does not implement {@see \OAuth2\Interfaces\IUserAuthenticator}.
</span><span class="line" id="613"> 613: </span><span class="php-comment">     * - if the private key is invalid.
</span><span class="line" id="614"> 614: </span><span class="php-comment">     * - if ssl signing fails due to system errors.
</span><span class="line" id="615"> 615: </span><span class="php-comment">     * - if the token storage fails to save the token record.
</span><span class="line" id="616"> 616: </span><span class="php-comment">     *
</span><span class="line" id="617"> 617: </span><span class="php-comment">     * @uses \OAuth2\Interfaces\ITokenStorage::saveTokenRecord()
</span><span class="line" id="618"> 618: </span><span class="php-comment">     *
</span><span class="line" id="619"> 619: </span><span class="php-comment">     * @used_by authenticateUser()
</span><span class="line" id="620"> 620: </span><span class="php-comment">     * @used_by refreshTokens()
</span><span class="line" id="621"> 621: </span><span class="php-comment">     *
</span><span class="line" id="622"> 622: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="623"> 623: </span><span class="php-comment">     */</span>
<span class="line" id="624"> 624: </span>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> createTokenRecord(<span class="php-var">$user_id</span>, <span class="php-var">$client_id</span>, &amp;<span class="php-var">$response</span>)
<span class="line" id="625"> 625: </span>    {
<span class="line" id="626"> 626: </span>        <span class="php-var">$response</span>[<span class="php-quote">&quot;user_id&quot;</span>] = <span class="php-var">$user_id</span>;
<span class="line" id="627"> 627: </span>        <span class="php-var">$response</span>[<span class="php-quote">&quot;client_id&quot;</span>] = <span class="php-var">$client_id</span>;
<span class="line" id="628"> 628: </span>        
<span class="line" id="629"> 629: </span>        <span class="php-var">$response</span>[<span class="php-quote">&quot;refresh_token&quot;</span>] = <span class="php-var">$this</span>-&gt;generateToken();
<span class="line" id="630"> 630: </span>        <span class="php-var">$response</span>[<span class="php-quote">&quot;refresh_token_expire&quot;</span>] = <span class="php-keyword2">time</span>() + <span class="php-var">$this</span>-&gt;refresh_token_ttl;
<span class="line" id="631"> 631: </span>        
<span class="line" id="632"> 632: </span>        <span class="php-var">$response</span>[<span class="php-quote">&quot;access_token&quot;</span>] = <span class="php-var">$this</span>-&gt;generateToken();
<span class="line" id="633"> 633: </span>        <span class="php-var">$response</span>[<span class="php-quote">&quot;access_token_expire&quot;</span>] = <span class="php-keyword2">time</span>() + <span class="php-var">$this</span>-&gt;access_token_ttl;
<span class="line" id="634"> 634: </span>        
<span class="line" id="635"> 635: </span>        <span class="php-var">$response</span>[<span class="php-quote">&quot;last_activity&quot;</span>] = <span class="php-keyword2">time</span>();
<span class="line" id="636"> 636: </span>        
<span class="line" id="637"> 637: </span>        <span class="php-var">$payload</span> = [<span class="php-quote">&quot;access_token&quot;</span> =&gt; <span class="php-var">$response</span>[<span class="php-quote">&quot;access_token&quot;</span>], <span class="php-quote">&quot;access_token_expire&quot;</span> =&gt; <span class="php-var">$response</span>[<span class="php-quote">&quot;access_token_expire&quot;</span>], <span class="php-quote">&quot;user_id&quot;</span> =&gt; <span class="php-var">$user_id</span>, <span class="php-quote">&quot;client_id&quot;</span> =&gt; <span class="php-var">$client_id</span>];
<span class="line" id="638"> 638: </span>        
<span class="line" id="639"> 639: </span>        <span class="php-var">$response</span>[<span class="php-quote">&quot;jwt_access_token&quot;</span>] = <span class="php-var">$this</span>-&gt;createJwtToken(<span class="php-var">$payload</span>);
<span class="line" id="640"> 640: </span>        
<span class="line" id="641"> 641: </span>        <span class="php-var">$this</span>-&gt;token_storage-&gt;saveTokenRecord(<span class="php-var">$response</span>);
<span class="line" id="642"> 642: </span>        
<span class="line" id="643"> 643: </span>        <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<span class="line" id="644"> 644: </span>    }
<span class="line" id="645"> 645: </span>    
<span class="line" id="646"> 646: </span>    <span class="php-comment">/**
</span><span class="line" id="647"> 647: </span><span class="php-comment">     * Initializes the authentication manager with parameters.
</span><span class="line" id="648"> 648: </span><span class="php-comment">     *
</span><span class="line" id="649"> 649: </span><span class="php-comment">     * @param array $parameters
</span><span class="line" id="650"> 650: </span><span class="php-comment">     * The parameters are:
</span><span class="line" id="651"> 651: </span><span class="php-comment">     *
</span><span class="line" id="652"> 652: </span><span class="php-comment">     * - $parameters[&quot;access_token_ttl&quot;] - time to live in seconds for the access token.
</span><span class="line" id="653"> 653: </span><span class="php-comment">     *
</span><span class="line" id="654"> 654: </span><span class="php-comment">     * - $parameters[&quot;refresh_token_ttl&quot;] - time to live in seconds for the refresh token.
</span><span class="line" id="655"> 655: </span><span class="php-comment">     *
</span><span class="line" id="656"> 656: </span><span class="php-comment">     * - $parameters[&quot;max_token_inactivity_days&quot;] - maximal number of inactivity days for the token.
</span><span class="line" id="657"> 657: </span><span class="php-comment">     *
</span><span class="line" id="658"> 658: </span><span class="php-comment">     * - $parameters[&quot;encryption_algorithm&quot;] - the encryption algorithm used for signing. The following
</span><span class="line" id="659"> 659: </span><span class="php-comment">     * algorithms are supported: HS256, HS384, HS512, RS256, RS384, RS512.
</span><span class="line" id="660"> 660: </span><span class="php-comment">     *
</span><span class="line" id="661"> 661: </span><span class="php-comment">     * - $parameters[&quot;public_key&quot;] - location of the public key file. Required for the algorithms: RS256, RS384, RS512.
</span><span class="line" id="662"> 662: </span><span class="php-comment">     *
</span><span class="line" id="663"> 663: </span><span class="php-comment">     * - $parameters[&quot;private_key&quot;] - location of the private key file. Required for the algorithms: RS256, RS384, RS512.
</span><span class="line" id="664"> 664: </span><span class="php-comment">     *
</span><span class="line" id="665"> 665: </span><span class="php-comment">     * - $parameters[&quot;pass_phrase&quot;] - the pass phrase for the private key if necessary.
</span><span class="line" id="666"> 666: </span><span class="php-comment">     *
</span><span class="line" id="667"> 667: </span><span class="php-comment">     * - $parameters[&quot;token_storage&quot;] - the object implementing the interface {@see \OAuth2\Interfaces\ITokenStorage}. It is used for storing and
</span><span class="line" id="668"> 668: </span><span class="php-comment">     * validating of the stored tokens.
</span><span class="line" id="669"> 669: </span><span class="php-comment">     *
</span><span class="line" id="670"> 670: </span><span class="php-comment">     * - $parameters[&quot;user_authenticator&quot;] - the object implementing the interface {@see \OAuth2\Interfaces\IUserAuthenticator}. It is used for authentication
</span><span class="line" id="671"> 671: </span><span class="php-comment">     * of the user upon his credentials before generation of the tokens.
</span><span class="line" id="672"> 672: </span><span class="php-comment">     *
</span><span class="line" id="673"> 673: </span><span class="php-comment">     * @return boolean
</span><span class="line" id="674"> 674: </span><span class="php-comment">     * returns true upon successful initialization, otherwise false.
</span><span class="line" id="675"> 675: </span><span class="php-comment">     *
</span><span class="line" id="676"> 676: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="677"> 677: </span><span class="php-comment">     * It might throw an exception in the case of any system errors:
</span><span class="line" id="678"> 678: </span><span class="php-comment">     *
</span><span class="line" id="679"> 679: </span><span class="php-comment">     * - if any required initialization parameters are empty.
</span><span class="line" id="680"> 680: </span><span class="php-comment">     * - if any initialization parameters are invalid.
</span><span class="line" id="681"> 681: </span><span class="php-comment">     * - if token_storage does not implement {@see \OAuth2\Interfaces\ITokenStorage}.
</span><span class="line" id="682"> 682: </span><span class="php-comment">     * - if user_authenticator does not implement {@see \OAuth2\Interfaces\IUserAuthenticator}.
</span><span class="line" id="683"> 683: </span><span class="php-comment">     *
</span><span class="line" id="684"> 684: </span><span class="php-comment">     * @see \OAuth2\Interfaces\ITokenStorage
</span><span class="line" id="685"> 685: </span><span class="php-comment">     * @see \OAuth2\Interfaces\IUserAuthenticator
</span><span class="line" id="686"> 686: </span><span class="php-comment">     *
</span><span class="line" id="687"> 687: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="688"> 688: </span><span class="php-comment">     */</span>
<span class="line" id="689"> 689: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> init(<span class="php-var">$parameters</span>)
<span class="line" id="690"> 690: </span>    {
<span class="line" id="691"> 691: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$parameters</span>[<span class="php-quote">&quot;access_token_ttl&quot;</span>])) {
<span class="line" id="692"> 692: </span>            <span class="php-var">$this</span>-&gt;access_token_ttl = <span class="php-var">$parameters</span>[<span class="php-quote">&quot;access_token_ttl&quot;</span>];
<span class="line" id="693"> 693: </span>        }
<span class="line" id="694"> 694: </span>        
<span class="line" id="695"> 695: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$parameters</span>[<span class="php-quote">&quot;refresh_token_ttl&quot;</span>])) {
<span class="line" id="696"> 696: </span>            <span class="php-var">$this</span>-&gt;refresh_token_ttl = <span class="php-var">$parameters</span>[<span class="php-quote">&quot;refresh_token_ttl&quot;</span>];
<span class="line" id="697"> 697: </span>        }
<span class="line" id="698"> 698: </span>        
<span class="line" id="699"> 699: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$parameters</span>[<span class="php-quote">&quot;max_token_inactivity_days&quot;</span>])) {
<span class="line" id="700"> 700: </span>            <span class="php-var">$this</span>-&gt;max_token_inactivity_days = <span class="php-var">$parameters</span>[<span class="php-quote">&quot;max_token_inactivity_days&quot;</span>];
<span class="line" id="701"> 701: </span>        }
<span class="line" id="702"> 702: </span>        
<span class="line" id="703"> 703: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$parameters</span>[<span class="php-quote">&quot;token_storage&quot;</span>])) {
<span class="line" id="704"> 704: </span>            <span class="php-var">$this</span>-&gt;token_storage = <span class="php-var">$parameters</span>[<span class="php-quote">&quot;token_storage&quot;</span>];
<span class="line" id="705"> 705: </span>        }
<span class="line" id="706"> 706: </span>        
<span class="line" id="707"> 707: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$parameters</span>[<span class="php-quote">&quot;user_authenticator&quot;</span>])) {
<span class="line" id="708"> 708: </span>            <span class="php-var">$this</span>-&gt;user_authenticator = <span class="php-var">$parameters</span>[<span class="php-quote">&quot;user_authenticator&quot;</span>];
<span class="line" id="709"> 709: </span>        }
<span class="line" id="710"> 710: </span>        
<span class="line" id="711"> 711: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$parameters</span>[<span class="php-quote">&quot;encryption_algorithm&quot;</span>])) {
<span class="line" id="712"> 712: </span>            <span class="php-var">$this</span>-&gt;encryption_algorithm = <span class="php-var">$parameters</span>[<span class="php-quote">&quot;encryption_algorithm&quot;</span>];
<span class="line" id="713"> 713: </span>        }
<span class="line" id="714"> 714: </span>        
<span class="line" id="715"> 715: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$parameters</span>[<span class="php-quote">&quot;secret_key&quot;</span>])) {
<span class="line" id="716"> 716: </span>            <span class="php-var">$this</span>-&gt;secret_key = <span class="php-var">$parameters</span>[<span class="php-quote">&quot;secret_key&quot;</span>];
<span class="line" id="717"> 717: </span>        }
<span class="line" id="718"> 718: </span>        
<span class="line" id="719"> 719: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$parameters</span>[<span class="php-quote">&quot;public_key&quot;</span>])) {
<span class="line" id="720"> 720: </span>            <span class="php-var">$this</span>-&gt;public_key = <span class="php-var">$parameters</span>[<span class="php-quote">&quot;public_key&quot;</span>];
<span class="line" id="721"> 721: </span>        }
<span class="line" id="722"> 722: </span>        
<span class="line" id="723"> 723: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$parameters</span>[<span class="php-quote">&quot;private_key&quot;</span>])) {
<span class="line" id="724"> 724: </span>            <span class="php-var">$this</span>-&gt;private_key = <span class="php-var">$parameters</span>[<span class="php-quote">&quot;private_key&quot;</span>];
<span class="line" id="725"> 725: </span>        }
<span class="line" id="726"> 726: </span>        
<span class="line" id="727"> 727: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$parameters</span>[<span class="php-quote">&quot;pass_phrase&quot;</span>])) {
<span class="line" id="728"> 728: </span>            <span class="php-var">$this</span>-&gt;pass_phrase = <span class="php-var">$parameters</span>[<span class="php-quote">&quot;pass_phrase&quot;</span>];
<span class="line" id="729"> 729: </span>        }
<span class="line" id="730"> 730: </span>        
<span class="line" id="731"> 731: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;validateParameters();
<span class="line" id="732"> 732: </span>    }
<span class="line" id="733"> 733: </span>    
<span class="line" id="734"> 734: </span>    <span class="php-comment">/**
</span><span class="line" id="735"> 735: </span><span class="php-comment">     * Authenticates the user based on the specified credentials and writes the response.
</span><span class="line" id="736"> 736: </span><span class="php-comment">     *
</span><span class="line" id="737"> 737: </span><span class="php-comment">     * @param array $credentials
</span><span class="line" id="738"> 738: </span><span class="php-comment">     * The credentials for the authentication. The expected credentials are:
</span><span class="line" id="739"> 739: </span><span class="php-comment">     *
</span><span class="line" id="740"> 740: </span><span class="php-comment">     * - $credentials[&quot;client_id&quot;] - id of the client (device token etc.).
</span><span class="line" id="741"> 741: </span><span class="php-comment">     *
</span><span class="line" id="742"> 742: </span><span class="php-comment">     * - $credentials[&quot;user_login&quot;] - the user login.
</span><span class="line" id="743"> 743: </span><span class="php-comment">     *
</span><span class="line" id="744"> 744: </span><span class="php-comment">     * - $credentials[&quot;user_password&quot;] - the user password.
</span><span class="line" id="745"> 745: </span><span class="php-comment">     *
</span><span class="line" id="746"> 746: </span><span class="php-comment">     * @param array $response
</span><span class="line" id="747"> 747: </span><span class="php-comment">     * The response upon successful authentication. The expected properties are:
</span><span class="line" id="748"> 748: </span><span class="php-comment">     *
</span><span class="line" id="749"> 749: </span><span class="php-comment">     * - $response[&quot;user_id&quot;] - id of the user.
</span><span class="line" id="750"> 750: </span><span class="php-comment">     *
</span><span class="line" id="751"> 751: </span><span class="php-comment">     * - $response[&quot;client_id&quot;] - id of the client (device token etc.).
</span><span class="line" id="752"> 752: </span><span class="php-comment">     *
</span><span class="line" id="753"> 753: </span><span class="php-comment">     * - $response[&quot;access_token&quot;] - access token generated upon successful authentication.
</span><span class="line" id="754"> 754: </span><span class="php-comment">     *
</span><span class="line" id="755"> 755: </span><span class="php-comment">     * - $response[&quot;access_token_expire&quot;] - expiration time of the access token.
</span><span class="line" id="756"> 756: </span><span class="php-comment">     *
</span><span class="line" id="757"> 757: </span><span class="php-comment">     * - $response[&quot;refresh_token&quot;] - refresh token generated upon successful authentication.
</span><span class="line" id="758"> 758: </span><span class="php-comment">     *
</span><span class="line" id="759"> 759: </span><span class="php-comment">     * - $response[&quot;refresh_token_expire&quot;] - expiration time of the refresh token.
</span><span class="line" id="760"> 760: </span><span class="php-comment">     *
</span><span class="line" id="761"> 761: </span><span class="php-comment">     * - $response[&quot;last_activity&quot;] - last activity time of the user of this token.
</span><span class="line" id="762"> 762: </span><span class="php-comment">     *
</span><span class="line" id="763"> 763: </span><span class="php-comment">     * - $response[&quot;jwt_access_token&quot;] - jwt access token generated upon successful authentication. JWT access
</span><span class="line" id="764"> 764: </span><span class="php-comment">     * token is the access token encoded and signed by the JWT standard approach.
</span><span class="line" id="765"> 765: </span><span class="php-comment">     *
</span><span class="line" id="766"> 766: </span><span class="php-comment">     * @return boolean
</span><span class="line" id="767"> 767: </span><span class="php-comment">     * Returns true upon success, otherwise false.
</span><span class="line" id="768"> 768: </span><span class="php-comment">     *
</span><span class="line" id="769"> 769: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="770"> 770: </span><span class="php-comment">     * It might throw an exception in the case of any system errors:
</span><span class="line" id="771"> 771: </span><span class="php-comment">     *
</span><span class="line" id="772"> 772: </span><span class="php-comment">     * - if any required initialization parameters are empty.
</span><span class="line" id="773"> 773: </span><span class="php-comment">     * - if any initialization parameters are invalid.
</span><span class="line" id="774"> 774: </span><span class="php-comment">     * - if token_storage does not implement {@see \OAuth2\Interfaces\ITokenStorage}.
</span><span class="line" id="775"> 775: </span><span class="php-comment">     * - if user_authenticator does not implement {@see \OAuth2\Interfaces\IUserAuthenticator}.
</span><span class="line" id="776"> 776: </span><span class="php-comment">     * - if the private key is invalid.
</span><span class="line" id="777"> 777: </span><span class="php-comment">     * - if ssl signing fails due to system errors.
</span><span class="line" id="778"> 778: </span><span class="php-comment">     * - if the token storage fails to save the token record.
</span><span class="line" id="779"> 779: </span><span class="php-comment">     *
</span><span class="line" id="780"> 780: </span><span class="php-comment">     * @throws \OAuth2\InvalidCredentialsException
</span><span class="line" id="781"> 781: </span><span class="php-comment">     * It might throw the InvalidCredentialsException if the authentication fails.
</span><span class="line" id="782"> 782: </span><span class="php-comment">     *
</span><span class="line" id="783"> 783: </span><span class="php-comment">     * @throws \OAuth2\MissingParametersException
</span><span class="line" id="784"> 784: </span><span class="php-comment">     * It might throw the MissingParametersException if any required paramters are empty.
</span><span class="line" id="785"> 785: </span><span class="php-comment">     *
</span><span class="line" id="786"> 786: </span><span class="php-comment">     * @uses createTokenRecord()
</span><span class="line" id="787"> 787: </span><span class="php-comment">     *
</span><span class="line" id="788"> 788: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="789"> 789: </span><span class="php-comment">     */</span>
<span class="line" id="790"> 790: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> authenticateUser(<span class="php-var">$credentials</span>, &amp;<span class="php-var">$response</span>)
<span class="line" id="791"> 791: </span>    {
<span class="line" id="792"> 792: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$credentials</span>[<span class="php-quote">&quot;client_id&quot;</span>])) {
<span class="line" id="793"> 793: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MissingParametersException(<span class="php-quote">&quot;The client id is not specified!&quot;</span>);
<span class="line" id="794"> 794: </span>        }
<span class="line" id="795"> 795: </span>        
<span class="line" id="796"> 796: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;createTokenRecord(<span class="php-var">$this</span>-&gt;user_authenticator-&gt;authenticateUser(<span class="php-var">$credentials</span>), <span class="php-var">$credentials</span>[<span class="php-quote">&quot;client_id&quot;</span>], <span class="php-var">$response</span>);
<span class="line" id="797"> 797: </span>    }
<span class="line" id="798"> 798: </span>    
<span class="line" id="799"> 799: </span>    <span class="php-comment">/**
</span><span class="line" id="800"> 800: </span><span class="php-comment">     * Refreshes the access and refresh tokens by using the valid refresh token.
</span><span class="line" id="801"> 801: </span><span class="php-comment">     *
</span><span class="line" id="802"> 802: </span><span class="php-comment">     * @param string $refresh_token
</span><span class="line" id="803"> 803: </span><span class="php-comment">     * The refresh token generated upon successful authentication.
</span><span class="line" id="804"> 804: </span><span class="php-comment">     *
</span><span class="line" id="805"> 805: </span><span class="php-comment">     * @param string $user_id
</span><span class="line" id="806"> 806: </span><span class="php-comment">     * The user id for which the refresh token was issued.
</span><span class="line" id="807"> 807: </span><span class="php-comment">     *
</span><span class="line" id="808"> 808: </span><span class="php-comment">     * @param string $client_id
</span><span class="line" id="809"> 809: </span><span class="php-comment">     * The client id for which the refresh token was issued.
</span><span class="line" id="810"> 810: </span><span class="php-comment">     *
</span><span class="line" id="811"> 811: </span><span class="php-comment">     * @param array $response
</span><span class="line" id="812"> 812: </span><span class="php-comment">     * The response upon successful refresh. The expected properties are:
</span><span class="line" id="813"> 813: </span><span class="php-comment">     *
</span><span class="line" id="814"> 814: </span><span class="php-comment">     * - $response[&quot;user_id&quot;] - id of the user.
</span><span class="line" id="815"> 815: </span><span class="php-comment">     *
</span><span class="line" id="816"> 816: </span><span class="php-comment">     * - $response[&quot;client_id&quot;] - id of the client (device token etc.).
</span><span class="line" id="817"> 817: </span><span class="php-comment">     *
</span><span class="line" id="818"> 818: </span><span class="php-comment">     * - $response[&quot;access_token&quot;] - access token generated upon successful authentication.
</span><span class="line" id="819"> 819: </span><span class="php-comment">     *
</span><span class="line" id="820"> 820: </span><span class="php-comment">     * - $response[&quot;access_token_expire&quot;] - expiration time of the access token.
</span><span class="line" id="821"> 821: </span><span class="php-comment">     *
</span><span class="line" id="822"> 822: </span><span class="php-comment">     * - $response[&quot;refresh_token&quot;] - refresh token generated upon successful authentication.
</span><span class="line" id="823"> 823: </span><span class="php-comment">     *
</span><span class="line" id="824"> 824: </span><span class="php-comment">     * - $response[&quot;refresh_token_expire&quot;] - expiration time of the refresh token.
</span><span class="line" id="825"> 825: </span><span class="php-comment">     *
</span><span class="line" id="826"> 826: </span><span class="php-comment">     * - $response[&quot;last_activity&quot;] - last activity time of the user of this token.
</span><span class="line" id="827"> 827: </span><span class="php-comment">     *
</span><span class="line" id="828"> 828: </span><span class="php-comment">     * - $response[&quot;jwt_access_token&quot;] - jwt access token generated upon successful authentication. JWT access
</span><span class="line" id="829"> 829: </span><span class="php-comment">     * token is the access token encoded and signed by the JWT standard approach.
</span><span class="line" id="830"> 830: </span><span class="php-comment">     *
</span><span class="line" id="831"> 831: </span><span class="php-comment">     * @return boolean
</span><span class="line" id="832"> 832: </span><span class="php-comment">     * Returns true upon success, otherwise false.
</span><span class="line" id="833"> 833: </span><span class="php-comment">     *
</span><span class="line" id="834"> 834: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="835"> 835: </span><span class="php-comment">     * It might throw an exception in the case of any system errors:
</span><span class="line" id="836"> 836: </span><span class="php-comment">     *
</span><span class="line" id="837"> 837: </span><span class="php-comment">     * - if any required initialization parameters are empty.
</span><span class="line" id="838"> 838: </span><span class="php-comment">     * - if any initialization parameters are invalid.
</span><span class="line" id="839"> 839: </span><span class="php-comment">     * - if token_storage does not implement {@see \OAuth2\Interfaces\ITokenStorage}.
</span><span class="line" id="840"> 840: </span><span class="php-comment">     * - if user_authenticator does not implement {@see \OAuth2\Interfaces\IUserAuthenticator}.
</span><span class="line" id="841"> 841: </span><span class="php-comment">     * - if the private key is invalid.
</span><span class="line" id="842"> 842: </span><span class="php-comment">     * - if ssl signing fails due to system errors.
</span><span class="line" id="843"> 843: </span><span class="php-comment">     * - if the token storage fails to verify the token record.
</span><span class="line" id="844"> 844: </span><span class="php-comment">     * - if the token storage fails to save the token record.
</span><span class="line" id="845"> 845: </span><span class="php-comment">     *
</span><span class="line" id="846"> 846: </span><span class="php-comment">     * @throws \OAuth2\InvalidTokenException
</span><span class="line" id="847"> 847: </span><span class="php-comment">     * It might throw the InvalidTokenException if the refresh token is invalid or expired.
</span><span class="line" id="848"> 848: </span><span class="php-comment">     *
</span><span class="line" id="849"> 849: </span><span class="php-comment">     * @throws \OAuth2\TokenExpiredException
</span><span class="line" id="850"> 850: </span><span class="php-comment">     * It might throw the TokenExpiredException if the refresh token is expired.
</span><span class="line" id="851"> 851: </span><span class="php-comment">     *
</span><span class="line" id="852"> 852: </span><span class="php-comment">     * @throws \OAuth2\MissingParametersException
</span><span class="line" id="853"> 853: </span><span class="php-comment">     * It might throw the MissingParametersException if any required paramters are empty.
</span><span class="line" id="854"> 854: </span><span class="php-comment">     *
</span><span class="line" id="855"> 855: </span><span class="php-comment">     * @uses createTokenRecord()
</span><span class="line" id="856"> 856: </span><span class="php-comment">     * @uses verifyRefreshToken()
</span><span class="line" id="857"> 857: </span><span class="php-comment">     *
</span><span class="line" id="858"> 858: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="859"> 859: </span><span class="php-comment">     */</span>
<span class="line" id="860"> 860: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> refreshTokens(<span class="php-var">$refresh_token</span>, <span class="php-var">$user_id</span>, <span class="php-var">$client_id</span>, &amp;<span class="php-var">$response</span>)
<span class="line" id="861"> 861: </span>    {
<span class="line" id="862"> 862: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;verifyRefreshToken(<span class="php-var">$refresh_token</span>, <span class="php-var">$user_id</span>, <span class="php-var">$client_id</span>)) {
<span class="line" id="863"> 863: </span>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<span class="line" id="864"> 864: </span>        }
<span class="line" id="865"> 865: </span>        
<span class="line" id="866"> 866: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;createTokenRecord(<span class="php-var">$user_id</span>, <span class="php-var">$client_id</span>, <span class="php-var">$response</span>);
<span class="line" id="867"> 867: </span>    }
<span class="line" id="868"> 868: </span>    
<span class="line" id="869"> 869: </span>    <span class="php-comment">/**
</span><span class="line" id="870"> 870: </span><span class="php-comment">     * Verifies the jwt access token.
</span><span class="line" id="871"> 871: </span><span class="php-comment">     *
</span><span class="line" id="872"> 872: </span><span class="php-comment">     * @param string $jwt_access_token
</span><span class="line" id="873"> 873: </span><span class="php-comment">     * The jwt access token generated upon successful authentication.
</span><span class="line" id="874"> 874: </span><span class="php-comment">     *
</span><span class="line" id="875"> 875: </span><span class="php-comment">     * @param boolean $check_on_server
</span><span class="line" id="876"> 876: </span><span class="php-comment">     * This flag defines whether only the signatire should be checked or also the
</span><span class="line" id="877"> 877: </span><span class="php-comment">     * authentication server should be asked.
</span><span class="line" id="878"> 878: </span><span class="php-comment">     *
</span><span class="line" id="879"> 879: </span><span class="php-comment">     * @return array|false
</span><span class="line" id="880"> 880: </span><span class="php-comment">     * Returns the payload array on successful verification, otherwise false.
</span><span class="line" id="881"> 881: </span><span class="php-comment">     *
</span><span class="line" id="882"> 882: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="883"> 883: </span><span class="php-comment">     * It might throw an exception in the case of any system errors:
</span><span class="line" id="884"> 884: </span><span class="php-comment">     *
</span><span class="line" id="885"> 885: </span><span class="php-comment">     * - if any required initialization parameters are empty.
</span><span class="line" id="886"> 886: </span><span class="php-comment">     * - if any initialization parameters are invalid.
</span><span class="line" id="887"> 887: </span><span class="php-comment">     * - if token_storage does not implement {@see \OAuth2\Interfaces\ITokenStorage}.
</span><span class="line" id="888"> 888: </span><span class="php-comment">     * - if user_authenticator does not implement {@see \OAuth2\Interfaces\IUserAuthenticator}.
</span><span class="line" id="889"> 889: </span><span class="php-comment">     * - if the public key is invalid.
</span><span class="line" id="890"> 890: </span><span class="php-comment">     * - if the ssl verification cannot be performed due to system errors.
</span><span class="line" id="891"> 891: </span><span class="php-comment">     * - if the token storage fails to verify the token record.
</span><span class="line" id="892"> 892: </span><span class="php-comment">     *
</span><span class="line" id="893"> 893: </span><span class="php-comment">     * @throws \OAuth2\InvalidTokenException
</span><span class="line" id="894"> 894: </span><span class="php-comment">     * It might throw the InvalidTokenException if the jwt access token is invalid.
</span><span class="line" id="895"> 895: </span><span class="php-comment">     *
</span><span class="line" id="896"> 896: </span><span class="php-comment">     * @throws \OAuth2\TokenExpiredException
</span><span class="line" id="897"> 897: </span><span class="php-comment">     * It might throw the TokenExpiredException if the jwt access token is expired.
</span><span class="line" id="898"> 898: </span><span class="php-comment">     *
</span><span class="line" id="899"> 899: </span><span class="php-comment">     * @throws \OAuth2\MissingParametersException
</span><span class="line" id="900"> 900: </span><span class="php-comment">     * It might throw the MissingParametersException if any required paramters are empty.
</span><span class="line" id="901"> 901: </span><span class="php-comment">     *
</span><span class="line" id="902"> 902: </span><span class="php-comment">     * @uses \OAuth2\Interfaces\ITokenStorage::loadTokenRecord()
</span><span class="line" id="903"> 903: </span><span class="php-comment">     *
</span><span class="line" id="904"> 904: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="905"> 905: </span><span class="php-comment">     */</span>
<span class="line" id="906"> 906: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> verifyJwtAccessToken(<span class="php-var">$jwt_access_token</span>, <span class="php-var">$check_on_server</span> = <span class="php-keyword1">true</span>)
<span class="line" id="907"> 907: </span>    {
<span class="line" id="908"> 908: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$jwt_access_token</span>)) {
<span class="line" id="909"> 909: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MissingParametersException(<span class="php-quote">&quot;The access token is not specified!&quot;</span>);
<span class="line" id="910"> 910: </span>        }
<span class="line" id="911"> 911: </span>
<span class="line" id="912"> 912: </span>        <span class="php-var">$payload</span> = <span class="php-var">$this</span>-&gt;getJwtPayload(<span class="php-var">$jwt_access_token</span>);
<span class="line" id="913"> 913: </span>        
<span class="line" id="914"> 914: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$payload</span>)) {
<span class="line" id="915"> 915: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidTokenException(<span class="php-quote">&quot;The jwt access token is invalid, the payload is empty!&quot;</span>);
<span class="line" id="916"> 916: </span>        }
<span class="line" id="917"> 917: </span>        
<span class="line" id="918"> 918: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$payload</span>[<span class="php-quote">&quot;access_token&quot;</span>])) {
<span class="line" id="919"> 919: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidTokenException(<span class="php-quote">&quot;The jwt access token is invalid, the payload does not have the property 'access_token'!&quot;</span>);
<span class="line" id="920"> 920: </span>        }
<span class="line" id="921"> 921: </span>        
<span class="line" id="922"> 922: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$payload</span>[<span class="php-quote">&quot;user_id&quot;</span>])) {
<span class="line" id="923"> 923: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidTokenException(<span class="php-quote">&quot;The jwt access token is invalid, the payload does not have the property 'user_id'!&quot;</span>);
<span class="line" id="924"> 924: </span>        }
<span class="line" id="925"> 925: </span>        
<span class="line" id="926"> 926: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$payload</span>[<span class="php-quote">&quot;client_id&quot;</span>])) {
<span class="line" id="927"> 927: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidTokenException(<span class="php-quote">&quot;The jwt access token is invalid, the payload does not have the property 'client_id'!&quot;</span>);
<span class="line" id="928"> 928: </span>        }
<span class="line" id="929"> 929: </span>        
<span class="line" id="930"> 930: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$payload</span>[<span class="php-quote">&quot;access_token_expire&quot;</span>])) {
<span class="line" id="931"> 931: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidTokenException(<span class="php-quote">&quot;The jwt access token is invalid, the payload does not have the property 'access_token_expire'!&quot;</span>);
<span class="line" id="932"> 932: </span>        }
<span class="line" id="933"> 933: </span>        
<span class="line" id="934"> 934: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword2">time</span>() &gt; <span class="php-var">$payload</span>[<span class="php-quote">&quot;access_token_expire&quot;</span>]) {
<span class="line" id="935"> 935: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> TokenExpiredException(<span class="php-quote">&quot;The access token is expired!&quot;</span>);
<span class="line" id="936"> 936: </span>        }
<span class="line" id="937"> 937: </span>        
<span class="line" id="938"> 938: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$check_on_server</span>) {
<span class="line" id="939"> 939: </span>            <span class="php-keyword1">return</span> <span class="php-var">$payload</span>;
<span class="line" id="940"> 940: </span>        }
<span class="line" id="941"> 941: </span>        
<span class="line" id="942"> 942: </span>        <span class="php-var">$token_record</span> = [
<span class="line" id="943"> 943: </span>            <span class="php-quote">&quot;user_id&quot;</span> =&gt; <span class="php-var">$payload</span>[<span class="php-quote">&quot;user_id&quot;</span>],
<span class="line" id="944"> 944: </span>            <span class="php-quote">&quot;client_id&quot;</span> =&gt; <span class="php-var">$payload</span>[<span class="php-quote">&quot;client_id&quot;</span>],
<span class="line" id="945"> 945: </span>            <span class="php-quote">&quot;access_token&quot;</span> =&gt; <span class="php-var">$payload</span>[<span class="php-quote">&quot;access_token&quot;</span>]
<span class="line" id="946"> 946: </span>        ];
<span class="line" id="947"> 947: </span>        
<span class="line" id="948"> 948: </span>        <span class="php-keyword1">try</span> {
<span class="line" id="949"> 949: </span>            <span class="php-var">$this</span>-&gt;token_storage-&gt;loadTokenRecord(<span class="php-var">$token_record</span>);
<span class="line" id="950"> 950: </span>        } <span class="php-keyword1">catch</span> (\OAuth2\InvalidTokenException <span class="php-var">$ex</span>) {
<span class="line" id="951"> 951: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \OAuth2\InvalidTokenException(<span class="php-quote">&quot;The access token is invalid, the token is not found in the storage!&quot;</span>);
<span class="line" id="952"> 952: </span>        }
<span class="line" id="953"> 953: </span>        
<span class="line" id="954"> 954: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword2">time</span>() &gt; <span class="php-var">$token_record</span>[<span class="php-quote">&quot;access_token_expire&quot;</span>]) {
<span class="line" id="955"> 955: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \OAuth2\TokenExpiredException(<span class="php-quote">&quot;The access token is expired!&quot;</span>);
<span class="line" id="956"> 956: </span>        }
<span class="line" id="957"> 957: </span>        
<span class="line" id="958"> 958: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword2">time</span>() &gt; <span class="php-var">$token_record</span>[<span class="php-quote">&quot;last_activity&quot;</span>] + <span class="php-var">$this</span>-&gt;max_token_inactivity_days * <span class="php-num">24</span> * <span class="php-num">3600</span>) {
<span class="line" id="959"> 959: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \OAuth2\TokenExpiredException(<span class="php-quote">&quot;The access token is expired!&quot;</span>);
<span class="line" id="960"> 960: </span>        }
<span class="line" id="961"> 961: </span>        
<span class="line" id="962"> 962: </span>        <span class="php-var">$token_record</span>[<span class="php-quote">&quot;last_activity&quot;</span>] = <span class="php-keyword2">time</span>();
<span class="line" id="963"> 963: </span>        <span class="php-var">$this</span>-&gt;token_storage-&gt;saveTokenRecord(<span class="php-var">$token_record</span>);
<span class="line" id="964"> 964: </span>        
<span class="line" id="965"> 965: </span>        <span class="php-keyword1">return</span> <span class="php-var">$payload</span>;
<span class="line" id="966"> 966: </span>    }
<span class="line" id="967"> 967: </span>    
<span class="line" id="968"> 968: </span>    <span class="php-comment">/**
</span><span class="line" id="969"> 969: </span><span class="php-comment">     * Verifies the refresh token.
</span><span class="line" id="970"> 970: </span><span class="php-comment">     *
</span><span class="line" id="971"> 971: </span><span class="php-comment">     * @param string $refresh_token
</span><span class="line" id="972"> 972: </span><span class="php-comment">     * The refresh token to be verified.
</span><span class="line" id="973"> 973: </span><span class="php-comment">     *
</span><span class="line" id="974"> 974: </span><span class="php-comment">     * @param string $user_id
</span><span class="line" id="975"> 975: </span><span class="php-comment">     * The user id for which the refresh token was issued.
</span><span class="line" id="976"> 976: </span><span class="php-comment">     *
</span><span class="line" id="977"> 977: </span><span class="php-comment">     * @param string $client_id
</span><span class="line" id="978"> 978: </span><span class="php-comment">     * The client id for which the refresh token was issued.
</span><span class="line" id="979"> 979: </span><span class="php-comment">     *
</span><span class="line" id="980"> 980: </span><span class="php-comment">     * @return boolean
</span><span class="line" id="981"> 981: </span><span class="php-comment">     * The method returns true upon successful verification, otherwise false.
</span><span class="line" id="982"> 982: </span><span class="php-comment">     *
</span><span class="line" id="983"> 983: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="984"> 984: </span><span class="php-comment">     * It might throw an exception in the case of any system errors.
</span><span class="line" id="985"> 985: </span><span class="php-comment">     *
</span><span class="line" id="986"> 986: </span><span class="php-comment">     * @throws \OAuth2\InvalidTokenException
</span><span class="line" id="987"> 987: </span><span class="php-comment">     * It should throw the InvalidTokenException if the refresh token is invalid.
</span><span class="line" id="988"> 988: </span><span class="php-comment">     *
</span><span class="line" id="989"> 989: </span><span class="php-comment">     * @throws \OAuth2\TokenExpiredException
</span><span class="line" id="990"> 990: </span><span class="php-comment">     * It might throw the TokenExpiredException if the jwt access token is expired.
</span><span class="line" id="991"> 991: </span><span class="php-comment">     *
</span><span class="line" id="992"> 992: </span><span class="php-comment">     * @throws \OAuth2\MissingParametersException
</span><span class="line" id="993"> 993: </span><span class="php-comment">     * It should throw the MissingParametersException if any required paramters are empty.
</span><span class="line" id="994"> 994: </span><span class="php-comment">     *
</span><span class="line" id="995"> 995: </span><span class="php-comment">     * @uses \OAuth2\Interfaces\ITokenStorage::loadTokenRecord()
</span><span class="line" id="996"> 996: </span><span class="php-comment">     *
</span><span class="line" id="997"> 997: </span><span class="php-comment">     * @used_by refreshTokens()
</span><span class="line" id="998"> 998: </span><span class="php-comment">     * @used_by invalidateUser()
</span><span class="line" id="999"> 999: </span><span class="php-comment">     * @used_by invalidateClient()
</span><span class="line" id="1000">1000: </span><span class="php-comment">     *
</span><span class="line" id="1001">1001: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1002">1002: </span><span class="php-comment">     */</span>
<span class="line" id="1003">1003: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> verifyRefreshToken(<span class="php-var">$refresh_token</span>, <span class="php-var">$user_id</span>, <span class="php-var">$client_id</span>)
<span class="line" id="1004">1004: </span>    {
<span class="line" id="1005">1005: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$user_id</span>)) {
<span class="line" id="1006">1006: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MissingParametersException(<span class="php-quote">&quot;The user id is not specified!&quot;</span>);
<span class="line" id="1007">1007: </span>        }
<span class="line" id="1008">1008: </span>    
<span class="line" id="1009">1009: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$client_id</span>)) {
<span class="line" id="1010">1010: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MissingParametersException(<span class="php-quote">&quot;The client id is not specified!&quot;</span>);
<span class="line" id="1011">1011: </span>        }
<span class="line" id="1012">1012: </span>    
<span class="line" id="1013">1013: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$refresh_token</span>)) {
<span class="line" id="1014">1014: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MissingParametersException(<span class="php-quote">&quot;The refresh token is not specified!&quot;</span>);
<span class="line" id="1015">1015: </span>        }
<span class="line" id="1016">1016: </span>
<span class="line" id="1017">1017: </span>        <span class="php-var">$token_record</span>[<span class="php-quote">&quot;user_id&quot;</span>] = <span class="php-var">$user_id</span>;
<span class="line" id="1018">1018: </span>        <span class="php-var">$token_record</span>[<span class="php-quote">&quot;client_id&quot;</span>] = <span class="php-var">$client_id</span>;
<span class="line" id="1019">1019: </span>        <span class="php-var">$token_record</span>[<span class="php-quote">&quot;refresh_token&quot;</span>] = <span class="php-var">$refresh_token</span>;
<span class="line" id="1020">1020: </span>        
<span class="line" id="1021">1021: </span>        <span class="php-keyword1">try</span> {
<span class="line" id="1022">1022: </span>            <span class="php-var">$this</span>-&gt;token_storage-&gt;loadTokenRecord(<span class="php-var">$token_record</span>);
<span class="line" id="1023">1023: </span>        } <span class="php-keyword1">catch</span> (\OAuth2\InvalidTokenException <span class="php-var">$ex</span>) {
<span class="line" id="1024">1024: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \OAuth2\InvalidTokenException(<span class="php-quote">&quot;The refresh token is invalid!&quot;</span>);
<span class="line" id="1025">1025: </span>        }
<span class="line" id="1026">1026: </span>        
<span class="line" id="1027">1027: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword2">time</span>() &gt; <span class="php-var">$token_record</span>[<span class="php-quote">&quot;access_token_expire&quot;</span>]) {
<span class="line" id="1028">1028: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \OAuth2\TokenExpiredException(<span class="php-quote">&quot;The refresh token is expired!&quot;</span>);
<span class="line" id="1029">1029: </span>        }
<span class="line" id="1030">1030: </span>        
<span class="line" id="1031">1031: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword2">time</span>() &gt; <span class="php-var">$token_record</span>[<span class="php-quote">&quot;last_activity&quot;</span>] + <span class="php-var">$this</span>-&gt;max_token_inactivity_days * <span class="php-num">24</span> * <span class="php-num">3600</span>) {
<span class="line" id="1032">1032: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \OAuth2\TokenExpiredException(<span class="php-quote">&quot;The refresh token is expired!&quot;</span>);
<span class="line" id="1033">1033: </span>        }
<span class="line" id="1034">1034: </span>        
<span class="line" id="1035">1035: </span>        <span class="php-var">$token_record</span>[<span class="php-quote">&quot;last_activity&quot;</span>] = <span class="php-keyword2">time</span>();
<span class="line" id="1036">1036: </span>        <span class="php-var">$this</span>-&gt;token_storage-&gt;saveTokenRecord(<span class="php-var">$token_record</span>);
<span class="line" id="1037">1037: </span>        
<span class="line" id="1038">1038: </span>        <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<span class="line" id="1039">1039: </span>    }
<span class="line" id="1040">1040: </span>    
<span class="line" id="1041">1041: </span>    <span class="php-comment">/**
</span><span class="line" id="1042">1042: </span><span class="php-comment">     * Invalidates all token records for the user.
</span><span class="line" id="1043">1043: </span><span class="php-comment">     *
</span><span class="line" id="1044">1044: </span><span class="php-comment">     * The invalidation by the user id is asserted by a valid client id and
</span><span class="line" id="1045">1045: </span><span class="php-comment">     * a valid refresh token. If the refresh token is expired, the invalidation
</span><span class="line" id="1046">1046: </span><span class="php-comment">     * can be done only after authentication.
</span><span class="line" id="1047">1047: </span><span class="php-comment">     *
</span><span class="line" id="1048">1048: </span><span class="php-comment">     * The invalidation is done by using {@see \OAuth2\Interfaces\ITokenStorage::deleteTokenRecordByKey()} with the key 'user_id'.
</span><span class="line" id="1049">1049: </span><span class="php-comment">     *
</span><span class="line" id="1050">1050: </span><span class="php-comment">     * @param string $user_id
</span><span class="line" id="1051">1051: </span><span class="php-comment">     * The user id for which the refresh token was issued.
</span><span class="line" id="1052">1052: </span><span class="php-comment">     *
</span><span class="line" id="1053">1053: </span><span class="php-comment">     * @param string $client_id
</span><span class="line" id="1054">1054: </span><span class="php-comment">     * The client id for which the refresh token was issued.
</span><span class="line" id="1055">1055: </span><span class="php-comment">     *
</span><span class="line" id="1056">1056: </span><span class="php-comment">     * @param string $refresh_token
</span><span class="line" id="1057">1057: </span><span class="php-comment">     * The refresh token generated upon successful authentication.
</span><span class="line" id="1058">1058: </span><span class="php-comment">     *
</span><span class="line" id="1059">1059: </span><span class="php-comment">     * @return boolean
</span><span class="line" id="1060">1060: </span><span class="php-comment">     * Returns true on successful invalidation, otherwise false.
</span><span class="line" id="1061">1061: </span><span class="php-comment">     *
</span><span class="line" id="1062">1062: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="1063">1063: </span><span class="php-comment">     * It might throw an exception in the case of any system errors:
</span><span class="line" id="1064">1064: </span><span class="php-comment">     *
</span><span class="line" id="1065">1065: </span><span class="php-comment">     * - if the token storage fails to verify the token record.
</span><span class="line" id="1066">1066: </span><span class="php-comment">     * - if the token storage fails to delete the token record.
</span><span class="line" id="1067">1067: </span><span class="php-comment">     *
</span><span class="line" id="1068">1068: </span><span class="php-comment">     * @throws \OAuth2\InvalidTokenException
</span><span class="line" id="1069">1069: </span><span class="php-comment">     * It might throw the InvalidTokenException if the refresh token is invalid or expired.
</span><span class="line" id="1070">1070: </span><span class="php-comment">     *
</span><span class="line" id="1071">1071: </span><span class="php-comment">     * @throws \OAuth2\TokenExpiredException
</span><span class="line" id="1072">1072: </span><span class="php-comment">     * It might throw the TokenExpiredException if the jwt refresh token is expired.
</span><span class="line" id="1073">1073: </span><span class="php-comment">     *
</span><span class="line" id="1074">1074: </span><span class="php-comment">     * @throws \OAuth2\MissingParametersException
</span><span class="line" id="1075">1075: </span><span class="php-comment">     * It might throw the MissingParametersException if any required paramters are empty.
</span><span class="line" id="1076">1076: </span><span class="php-comment">     *
</span><span class="line" id="1077">1077: </span><span class="php-comment">     * @uses verifyRefreshToken()
</span><span class="line" id="1078">1078: </span><span class="php-comment">     * @uses \OAuth2\Interfaces\ITokenStorage::deleteTokenRecordByKey()
</span><span class="line" id="1079">1079: </span><span class="php-comment">     *
</span><span class="line" id="1080">1080: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1081">1081: </span><span class="php-comment">     */</span>
<span class="line" id="1082">1082: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> invalidateUser(<span class="php-var">$user_id</span>, <span class="php-var">$client_id</span>, <span class="php-var">$refresh_token</span>)
<span class="line" id="1083">1083: </span>    {
<span class="line" id="1084">1084: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$user_id</span>)) {
<span class="line" id="1085">1085: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MissingParametersException(<span class="php-quote">&quot;The user id is not specified!&quot;</span>);
<span class="line" id="1086">1086: </span>        }
<span class="line" id="1087">1087: </span>        
<span class="line" id="1088">1088: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$client_id</span>)) {
<span class="line" id="1089">1089: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MissingParametersException(<span class="php-quote">&quot;The client id is not specified!&quot;</span>);
<span class="line" id="1090">1090: </span>        }
<span class="line" id="1091">1091: </span>        
<span class="line" id="1092">1092: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$refresh_token</span>)) {
<span class="line" id="1093">1093: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MissingParametersException(<span class="php-quote">&quot;The refresh token is not specified!&quot;</span>);
<span class="line" id="1094">1094: </span>        }
<span class="line" id="1095">1095: </span>        
<span class="line" id="1096">1096: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;verifyRefreshToken(<span class="php-var">$refresh_token</span>, <span class="php-var">$user_id</span>, <span class="php-var">$client_id</span>)) {
<span class="line" id="1097">1097: </span>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<span class="line" id="1098">1098: </span>        }
<span class="line" id="1099">1099: </span>        
<span class="line" id="1100">1100: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;token_storage-&gt;deleteTokenRecordByKey(<span class="php-quote">&quot;user_id&quot;</span>, <span class="php-var">$user_id</span>);
<span class="line" id="1101">1101: </span>    }
<span class="line" id="1102">1102: </span>    
<span class="line" id="1103">1103: </span>    <span class="php-comment">/**
</span><span class="line" id="1104">1104: </span><span class="php-comment">     * Invalidates all token records for the client.
</span><span class="line" id="1105">1105: </span><span class="php-comment">     *
</span><span class="line" id="1106">1106: </span><span class="php-comment">     * The invalidation by the client id is asserted by a valid client id and
</span><span class="line" id="1107">1107: </span><span class="php-comment">     * a valid refresh token. If the refresh token is expired, the invalidation
</span><span class="line" id="1108">1108: </span><span class="php-comment">     * can be done only after authentication.
</span><span class="line" id="1109">1109: </span><span class="php-comment">     *
</span><span class="line" id="1110">1110: </span><span class="php-comment">     * The invalidation is done by using {@see \OAuth2\Interfaces\ITokenStorage::deleteTokenRecordByKey()} with the key 'client_id'.
</span><span class="line" id="1111">1111: </span><span class="php-comment">     *
</span><span class="line" id="1112">1112: </span><span class="php-comment">     * @param string $user_id
</span><span class="line" id="1113">1113: </span><span class="php-comment">     * The user id for which the refresh token was issued.
</span><span class="line" id="1114">1114: </span><span class="php-comment">     *
</span><span class="line" id="1115">1115: </span><span class="php-comment">     * @param string $client_id
</span><span class="line" id="1116">1116: </span><span class="php-comment">     * The client id for which the refresh token was issued.
</span><span class="line" id="1117">1117: </span><span class="php-comment">     *
</span><span class="line" id="1118">1118: </span><span class="php-comment">     * @param string $refresh_token
</span><span class="line" id="1119">1119: </span><span class="php-comment">     * The refresh token generated upon successful authentication.
</span><span class="line" id="1120">1120: </span><span class="php-comment">     *
</span><span class="line" id="1121">1121: </span><span class="php-comment">     * @return boolean
</span><span class="line" id="1122">1122: </span><span class="php-comment">     * Returns true on successful invalidation, otherwise false.
</span><span class="line" id="1123">1123: </span><span class="php-comment">     *
</span><span class="line" id="1124">1124: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="1125">1125: </span><span class="php-comment">     * It might throw an exception in the case of any system errors:
</span><span class="line" id="1126">1126: </span><span class="php-comment">     *
</span><span class="line" id="1127">1127: </span><span class="php-comment">     * - if the token storage fails to verify the token record.
</span><span class="line" id="1128">1128: </span><span class="php-comment">     * - if the token storage fails to delete the token record.
</span><span class="line" id="1129">1129: </span><span class="php-comment">     *
</span><span class="line" id="1130">1130: </span><span class="php-comment">     * @throws \OAuth2\InvalidTokenException
</span><span class="line" id="1131">1131: </span><span class="php-comment">     * It might throw the InvalidTokenException if the refresh token is invalid or expired.
</span><span class="line" id="1132">1132: </span><span class="php-comment">     *
</span><span class="line" id="1133">1133: </span><span class="php-comment">     * @throws \OAuth2\TokenExpiredException
</span><span class="line" id="1134">1134: </span><span class="php-comment">     * It might throw the TokenExpiredException if the jwt refresh token is expired.
</span><span class="line" id="1135">1135: </span><span class="php-comment">     *
</span><span class="line" id="1136">1136: </span><span class="php-comment">     * @throws \OAuth2\MissingParametersException
</span><span class="line" id="1137">1137: </span><span class="php-comment">     * It might throw the MissingParametersException if any required paramters are empty.
</span><span class="line" id="1138">1138: </span><span class="php-comment">     *
</span><span class="line" id="1139">1139: </span><span class="php-comment">     * @uses verifyRefreshToken()
</span><span class="line" id="1140">1140: </span><span class="php-comment">     * @uses \OAuth2\Interfaces\ITokenStorage::deleteTokenRecordByKey()
</span><span class="line" id="1141">1141: </span><span class="php-comment">     *
</span><span class="line" id="1142">1142: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1143">1143: </span><span class="php-comment">     */</span>
<span class="line" id="1144">1144: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> invalidateClient(<span class="php-var">$user_id</span>, <span class="php-var">$client_id</span>, <span class="php-var">$refresh_token</span>)
<span class="line" id="1145">1145: </span>    {
<span class="line" id="1146">1146: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$user_id</span>)) {
<span class="line" id="1147">1147: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MissingParametersException(<span class="php-quote">&quot;The user id is not specified!&quot;</span>);
<span class="line" id="1148">1148: </span>        }
<span class="line" id="1149">1149: </span>        
<span class="line" id="1150">1150: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$client_id</span>)) {
<span class="line" id="1151">1151: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MissingParametersException(<span class="php-quote">&quot;The client id is not specified!&quot;</span>);
<span class="line" id="1152">1152: </span>        }
<span class="line" id="1153">1153: </span>        
<span class="line" id="1154">1154: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$refresh_token</span>)) {
<span class="line" id="1155">1155: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MissingParametersException(<span class="php-quote">&quot;The refresh token is not specified!&quot;</span>);
<span class="line" id="1156">1156: </span>        }
<span class="line" id="1157">1157: </span>        
<span class="line" id="1158">1158: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;verifyRefreshToken(<span class="php-var">$refresh_token</span>, <span class="php-var">$user_id</span>, <span class="php-var">$client_id</span>)) {
<span class="line" id="1159">1159: </span>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<span class="line" id="1160">1160: </span>        }
<span class="line" id="1161">1161: </span>        
<span class="line" id="1162">1162: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;token_storage-&gt;deleteTokenRecordByKey(<span class="php-quote">&quot;client_id&quot;</span>, <span class="php-var">$client_id</span>);
<span class="line" id="1163">1163: </span>    }
<span class="line" id="1164">1164: </span>    
<span class="line" id="1165">1165: </span>    <span class="php-comment">/**
</span><span class="line" id="1166">1166: </span><span class="php-comment">     * Invalidates the token record for the jwt access token.
</span><span class="line" id="1167">1167: </span><span class="php-comment">     *
</span><span class="line" id="1168">1168: </span><span class="php-comment">     * The invalidation is done by using {@see \OAuth2\Interfaces\ITokenStorage::deleteTokenRecordByKey()} with the key 'access_token'.
</span><span class="line" id="1169">1169: </span><span class="php-comment">     *
</span><span class="line" id="1170">1170: </span><span class="php-comment">     * The origin access token is extracted from the jwt payload.
</span><span class="line" id="1171">1171: </span><span class="php-comment">     *
</span><span class="line" id="1172">1172: </span><span class="php-comment">     * @param string $jwt_access_token
</span><span class="line" id="1173">1173: </span><span class="php-comment">     * The jwt access token generated upon successful authentication.
</span><span class="line" id="1174">1174: </span><span class="php-comment">     *
</span><span class="line" id="1175">1175: </span><span class="php-comment">     * @return boolean
</span><span class="line" id="1176">1176: </span><span class="php-comment">     * Returns true on successful invalidation, otherwise false.
</span><span class="line" id="1177">1177: </span><span class="php-comment">     *
</span><span class="line" id="1178">1178: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="1179">1179: </span><span class="php-comment">     * It might throw an exception in the case of any errors:
</span><span class="line" id="1180">1180: </span><span class="php-comment">     *
</span><span class="line" id="1181">1181: </span><span class="php-comment">     * - if any required initialization parameters are empty.
</span><span class="line" id="1182">1182: </span><span class="php-comment">     * - if any initialization parameters are invalid.
</span><span class="line" id="1183">1183: </span><span class="php-comment">     * - if token_storage does not implement {@see \OAuth2\Interfaces\ITokenStorage}.
</span><span class="line" id="1184">1184: </span><span class="php-comment">     * - if user_authenticator does not implement {@see \OAuth2\Interfaces\IUserAuthenticator}.
</span><span class="line" id="1185">1185: </span><span class="php-comment">     * - if the public key is invalid.
</span><span class="line" id="1186">1186: </span><span class="php-comment">     * - if the ssl verification cannot be performed due to system errors.
</span><span class="line" id="1187">1187: </span><span class="php-comment">     * - if the token storage fails to delete the token record.
</span><span class="line" id="1188">1188: </span><span class="php-comment">     *
</span><span class="line" id="1189">1189: </span><span class="php-comment">     * @throws \OAuth2\InvalidTokenException
</span><span class="line" id="1190">1190: </span><span class="php-comment">     * It might throw the InvalidTokenException if the jwt access token is invalid.
</span><span class="line" id="1191">1191: </span><span class="php-comment">     *
</span><span class="line" id="1192">1192: </span><span class="php-comment">     * @uses \OAuth2\Interfaces\ITokenStorage::deleteTokenRecordByKey()
</span><span class="line" id="1193">1193: </span><span class="php-comment">     *
</span><span class="line" id="1194">1194: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1195">1195: </span><span class="php-comment">     */</span>
<span class="line" id="1196">1196: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> invalidateJwtAccessToken(<span class="php-var">$jwt_access_token</span>)
<span class="line" id="1197">1197: </span>    {
<span class="line" id="1198">1198: </span>        <span class="php-var">$payload</span> = <span class="php-var">$this</span>-&gt;getJwtPayload(<span class="php-var">$jwt_access_token</span>, <span class="php-keyword1">true</span>);
<span class="line" id="1199">1199: </span>        
<span class="line" id="1200">1200: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$payload</span>)) {
<span class="line" id="1201">1201: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidTokenException(<span class="php-quote">&quot;The jwt access token is invalid, the payload is empty!&quot;</span>);
<span class="line" id="1202">1202: </span>        }
<span class="line" id="1203">1203: </span>        
<span class="line" id="1204">1204: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$payload</span>[<span class="php-quote">&quot;access_token&quot;</span>])) {
<span class="line" id="1205">1205: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidTokenException(<span class="php-quote">&quot;The jwt access token is invalid, the payload does not have the property 'access_token'!&quot;</span>);
<span class="line" id="1206">1206: </span>        }
<span class="line" id="1207">1207: </span>        
<span class="line" id="1208">1208: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;token_storage-&gt;deleteTokenRecordByKey(<span class="php-quote">&quot;access_token&quot;</span>, <span class="php-var">$payload</span>[<span class="php-quote">&quot;access_token&quot;</span>]);
<span class="line" id="1209">1209: </span>    }
<span class="line" id="1210">1210: </span>    
<span class="line" id="1211">1211: </span>    <span class="php-comment">/**
</span><span class="line" id="1212">1212: </span><span class="php-comment">     * Invalidates all token records for the refresh token.
</span><span class="line" id="1213">1213: </span><span class="php-comment">     *
</span><span class="line" id="1214">1214: </span><span class="php-comment">     * The invalidation is done by using {@see \OAuth2\Interfaces\ITokenStorage::deleteTokenRecordByKey()} with the key 'refresh_token'.
</span><span class="line" id="1215">1215: </span><span class="php-comment">     *
</span><span class="line" id="1216">1216: </span><span class="php-comment">     * @param string $refresh_token
</span><span class="line" id="1217">1217: </span><span class="php-comment">     * The refresh token generated upon successful authentication.
</span><span class="line" id="1218">1218: </span><span class="php-comment">     *
</span><span class="line" id="1219">1219: </span><span class="php-comment">     * @return boolean
</span><span class="line" id="1220">1220: </span><span class="php-comment">     * Returns true on successful invalidation, otherwise false.
</span><span class="line" id="1221">1221: </span><span class="php-comment">     *
</span><span class="line" id="1222">1222: </span><span class="php-comment">     * @throws \Exception
</span><span class="line" id="1223">1223: </span><span class="php-comment">     * It might throw an exception in the case of any system errors:
</span><span class="line" id="1224">1224: </span><span class="php-comment">     *
</span><span class="line" id="1225">1225: </span><span class="php-comment">     * - if the token storage fails to delete the token record.
</span><span class="line" id="1226">1226: </span><span class="php-comment">     *
</span><span class="line" id="1227">1227: </span><span class="php-comment">     * @throws \OAuth2\InvalidTokenException
</span><span class="line" id="1228">1228: </span><span class="php-comment">     * It should throw the InvalidTokenException if the refresh token is invalid.
</span><span class="line" id="1229">1229: </span><span class="php-comment">     *
</span><span class="line" id="1230">1230: </span><span class="php-comment">     * @uses \OAuth2\Interfaces\ITokenStorage::deleteTokenRecordByKey()
</span><span class="line" id="1231">1231: </span><span class="php-comment">     *
</span><span class="line" id="1232">1232: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1233">1233: </span><span class="php-comment">     */</span>
<span class="line" id="1234">1234: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> invalidateRefreshToken(<span class="php-var">$refresh_token</span>)
<span class="line" id="1235">1235: </span>    {
<span class="line" id="1236">1236: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;token_storage-&gt;deleteTokenRecordByKey(<span class="php-quote">&quot;refresh_token&quot;</span>, <span class="php-var">$refresh_token</span>);
<span class="line" id="1237">1237: </span>    }
<span class="line" id="1238">1238: </span>}
</code>
</pre>
</div>
                    
                    <div id="footer">
                        Generated on 2020-11-24 17:00
                    </div>                    
                </div>
            </div>
        </div>

        <script src="resources/jquery-3.2.1.min.js"></script>
        <script src="resources/jquery-ui-1.12.1.min.js"></script>

        <script src="elementlist.js"></script>
        <script src="resources/main.js"></script>
        
        <script src="resources/jquery.iviewer.js" type="text/javascript"></script>
        <script src="resources/jquery.mousewheel.js" type="text/javascript"></script>
        
        <script type="text/javascript">
            $(window).resize(function(){
                $("#viewer").height(1400);
            });

            $(document).ready(function() {
                $("#viewer").iviewer({src: 'resources/classes.svg', zoom_animation: false});
                $('#viewer img').bind('dragstart', function(event){
                    event.preventDefault();
                });
                $(window).resize();
            });
        </script>
        
    </body>
</html>


